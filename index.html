<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Basket Scout Pro - Ultra Stable</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --bg: #121212; --surface: #1e1e1e; --primary: #ffeb3b; --danger: #dc3545;
            --success: #28a745; --info: #007bff; --warning: #ff9800; --text: #ffffff;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; overflow-x: hidden; touch-action: manipulation; }
        
        /* Notifiche Flash */
        .flash-green { background: #1b5e20 !important; }
        .flash-red { background: #b71c1c !important; }
        .flash-blue { background: #0d47a1 !important; }

        /* Scoreboard */
        .scoreboard { display: grid; grid-template-columns: 1.2fr 1fr 1.2fr; background: #000; padding: 10px; border-radius: 12px; border: 2px solid #333; margin-bottom: 10px; align-items: center; text-align: center; }
        .score-box h1 { font-size: 48px; margin: 0; color: var(--primary); }
        .foul-team { font-size: 16px; color: var(--danger); font-weight: bold; }
        .bonus { color: var(--warning); font-size: 12px; border: 1px solid var(--warning); padding: 2px 5px; border-radius: 4px; visibility: hidden; }
        .bonus.active { visibility: visible; }
        .to-dots { display: flex; justify-content: center; gap: 4px; margin: 5px 0; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #444; }
        .dot.active { background: var(--warning); }

        /* Griglia Giocatori */
        .grid-giocatori { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .btn-giocatore { 
            background: var(--surface); color: white; border: 2px solid #444; border-radius: 12px; 
            padding: 15px 5px; position: relative; font-weight: bold; transition: 0.2s;
        }
        .btn-giocatore.in-campo { border-color: var(--success); box-shadow: inset 0 0 10px rgba(40,167,69,0.2); }
        .btn-giocatore.selected { background: var(--warning) !important; color: black; }
        .btn-giocatore.out { opacity: 0.3; pointer-events: none; }
        .p-name { display: block; font-size: 10px; margin-bottom: 5px; white-space: nowrap; overflow: hidden; }
        .p-num { font-size: 22px; display: block; }
        .p-pts { position: absolute; bottom: 5px; left: 8px; font-size: 12px; color: #7fff7f; }
        .p-foul { position: absolute; bottom: 5px; right: 8px; font-size: 14px; background: var(--danger); padding: 2px 6px; border-radius: 4px; }
        .p-special { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); font-size: 12px; color: cyan; font-weight: bold; }

        /* Pulsanti Azione */
        .actions-container { display: grid; gap: 8px; }
        .row-2-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; }
        .row-half { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .row-quad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .btn-act { padding: 18px 5px; border: none; border-radius: 8px; font-weight: bold; font-size: 13px; text-transform: uppercase; }

        /* Modali */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; overflow-y: auto; padding: 20px 15px; box-sizing: border-box; }
        .modal-content { background: var(--surface); padding: 20px; border-radius: 15px; border: 1px solid #444; max-width: 500px; margin: auto; width: 100%; }
        input, select { background: #333; border: 1px solid #555; color: white; padding: 12px; border-radius: 6px; margin: 10px 0; width: 100%; box-sizing: border-box; }
        
        /* Mappa Campo */
        #mappaTiro { width: 300px; height: 250px; background: #d2a679; border: 2px solid white; margin: 0 auto; position: relative; border-radius: 5px; overflow: hidden; }
        .canestro { position: absolute; top: 30px; left: 150px; width: 20px; height: 20px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); }
        .area-3pt { position: absolute; top: -100px; left: 15px; width: 270px; height: 260px; border: 2px solid white; border-radius: 0 0 150px 150px; pointer-events: none; }
        .pitturato { position: absolute; top: 0; left: 100px; width: 100px; height: 110px; border: 2px solid white; pointer-events: none; }
        .shot-dot { position: absolute; width: 10px; height: 10px; border-radius: 50%; transform: translate(-50%, -50%); border: 1px solid black; }

        /* Situazione Falli */
        .foul-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; align-items: center; }
        .f-num-box { border: 2px solid transparent; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 18px; }
        .f-num-box.active { border-color: var(--danger); }

        /* Cambi UI */
        .sub-divider { height: 2px; background: #555; margin: 20px 0; position: relative; }
        .sub-divider::after { content: 'BENCH'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--surface); padding: 0 10px; font-size: 10px; color: #888; }
        
        .footer-nav { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .btn-nav { background: #333; color: white; border: none; padding: 12px; border-radius: 6px; font-size: 12px; }

        /* Statistiche Finale */
        .stat-card { background: #000; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; }
    </style>
</head>
<body>

    <div id="setup" style="display: block;">
        <h2 style="text-align: center;">BASKET SCOUT PRO üèÄ</h2>
        <div id="main-menu">
            <button class="btn-act bg-info full-width" style="width: 100%; margin-bottom: 10px;" onclick="switchSetup('nuova')">NUOVA PARTITA</button>
            <button class="btn-act bg-warning full-width" style="width: 100%; margin-bottom: 10px;" onclick="switchSetup('carica')">CARICA PARTITA</button>
            <button class="btn-act bg-info full-width" style="width: 100%;" onclick="switchSetup('roster')">GESTIONE ROSTER</button>
        </div>

        <div id="step-nuova" style="display:none;">
            <button onclick="switchSetup('menu')" style="background:none; color:#aaa; border:none; margin-bottom:10px;">< INDIETRO</button>
            <input type="text" id="gameId" placeholder="CODICE PARTITA (es. FINALE2024)">
            <select id="durataQ"><option value="10">QUARTO: 10 MIN</option><option value="8">QUARTO: 8 MIN</option></select>
            <select id="durataOT"><option value="5">OT: 5 MIN</option><option value="4">OT: 4 MIN</option></select>
            <select id="selRoster" onchange="checkManual(this.value)"><option value="manual">INSERIMENTO MANUALE</option></select>
            <input type="text" id="teamOpp" placeholder="NOME SQUADRA AVVERSARIA">
            <div class="row-half">
                <button id="btnCasa" class="btn-act" onclick="setCasa(true)">CASA</button>
                <button id="btnFuori" class="btn-act" onclick="setCasa(false)">FUORI</button>
            </div>
            <button class="btn-act bg-success full-width" style="width: 100%; margin-top:15px;" onclick="vaiAConvocati()">AVANTI ></button>
        </div>

        <div id="step-convocati" style="display:none;">
            <h3>CONVOCAZIONI</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div id="conv-noi"><h4>NOI</h4><div id="list-noi"></div></div>
                <div id="conv-loro"><h4>LORO</h4><textarea id="list-loro" placeholder="Numeri divisi da spazio (es: 4 7 10 23)" style="width:100%; height:150px; background:#333; color:white; border-radius:6px; padding:10px;"></textarea></div>
            </div>
            <button class="btn-act bg-success full-width" style="width: 100%; margin-top:20px;" onclick="iniziaPartita()">VAI ALLA PARTITA üèÄ</button>
        </div>
    </div>

    <div id="gara" style="display: none;">
        <div class="scoreboard">
            <div>
                <div id="nameH" style="font-size:12px; font-weight:bold;">HOME</div>
                <h1 id="scoreH">0</h1>
                <div class="foul-team">FALLI: <span id="fTeamH">0</span> <span id="bonusH" class="bonus">BONUS</span></div>
                <div class="to-dots" id="toH"></div>
                <button class="btn-nav" style="font-size:10px; padding:4px;" onclick="addTO('H')">TIMEOUT</button>
            </div>
            <div>
                <div id="labelQ" style="color:var(--warning); font-weight:bold; font-size:20px;">Q1</div>
                <div id="gameCodeDisp" style="font-size:10px; color:#666; margin:5px 0;"></div>
                <button id="btnQ" class="btn-act bg-success" onclick="gestioneQuarto()">INIZIO Q1</button>
            </div>
            <div>
                <div id="nameA" style="font-size:12px; font-weight:bold;">AWAY</div>
                <h1 id="scoreA">0</h1>
                <div class="foul-team">FALLI: <span id="fTeamA">0</span> <span id="bonusA" class="bonus">BONUS</span></div>
                <div class="to-dots" id="toA"></div>
                <button class="btn-nav" style="font-size:10px; padding:4px;" onclick="addTO('A')">TIMEOUT</button>
            </div>
        </div>

        <div class="row-quad" style="margin-bottom:10px;">
            <button class="btn-act" style="background:#331a1a; color:#ff7f7f;" onclick="puntiAvv(1)">+1 AVV</button>
            <button class="btn-act" style="background:#331a1a; color:#ff7f7f;" onclick="puntiAvv(2)">+2 AVV</button>
            <button class="btn-act" style="background:#331a1a; color:#ff7f7f;" onclick="puntiAvv(3)">+3 AVV</button>
            <button class="btn-act bg-info" onclick="apriFalli()">SITUAZIONE FALLI</button>
        </div>

        <div class="grid-giocatori" id="gridGara"></div>

        <div class="actions-container" id="panelAzioni" style="opacity: 0.3; pointer-events: none;">
            <div class="row-2-1">
                <button class="btn-act bg-warning" onclick="apriTiro()">üèÄ TIRO</button>
                <button class="btn-act" style="background:#fff; color:#000;" onclick="apriLiberi()">LIBERI</button>
            </div>
            <div class="row-half">
                <button class="btn-act bg-danger" onclick="regFalloFatto()">üõë FALLO FATTO</button>
                <button class="btn-act bg-success" onclick="apriFalloSubito()">ü§ù FALLO SUBITO</button>
            </div>
            <div class="row-quad">
                <button class="btn-act" style="background:var(--info)" onclick="regQuick('R. DIF', 'blue')">R.DIF</button>
                <button class="btn-act" style="background:var(--info)" onclick="regQuick('R. OFF', 'blue')">R.OFF</button>
                <button class="btn-act bg-danger" onclick="regQuick('P. PERSA', 'red')">PERSA</button>
                <button class="btn-act bg-success" onclick="regQuick('RECUPERO', 'green')">RECUP</button>
            </div>
            <button class="btn-act" style="background:#fff; color:#000;" onclick="apriCambio()">üîÑ CAMBIO</button>
            <button class="btn-act" style="background:#9c27b0; color:#fff;" onclick="apriSpeciali()">‚ö†Ô∏è FALLI SPECIALI</button>
        </div>

        <div class="footer-nav">
            <button class="btn-nav" onclick="undo()">‚Ü©Ô∏è ANNULLA</button>
            <button class="btn-nav" onclick="apriEventi()">üìú EVENTI</button>
            <button class="btn-nav" onclick="mostraStatistiche(true)">üìä STATS</button>
        </div>
    </div>

    <div id="modTiro" class="modal">
        <div class="modal-content">
            <h3 id="infoTiro">Tiro da ?</h3>
            <div id="mappaTiro" onclick="gestisciToccoCampo(event)">
                <div class="canestro"></div>
                <div class="area-3pt"></div>
                <div class="pitturato"></div>
            </div>
            <div class="row-half" style="margin-top:20px;">
                <button class="btn-act bg-success" onclick="regEsitoTiro(true)">SEGNATO</button>
                <button class="btn-act bg-danger" onclick="regEsitoTiro(false)">SBAGLIATO</button>
            </div>
            <button class="btn-nav full-width" onclick="chiudiModale('modTiro')">ANNULLA</button>
        </div>
    </div>

    <div id="modLiberi" class="modal">
        <div class="modal-content">
            <h3>TIRI LIBERI</h3>
            <div id="seqLiberi" style="font-size:40px; margin:20px 0; min-height:50px;"></div>
            <div class="row-half">
                <button class="btn-act bg-success" onclick="regEsitoLibero(true)">‚úÖ OK</button>
                <button class="btn-act bg-danger" onclick="regEsitoLibero(false)">‚ùå NO</button>
            </div>
            <button class="btn-act full-width" style="margin-top:20px;" onclick="chiudiModale('modLiberi')">FINE</button>
        </div>
    </div>

    <div id="modCambio" class="modal">
        <div class="modal-content">
            <h3>üîÑ CAMBIO</h3>
            <div style="text-align: center;">
                <label>Tempo (MSS):</label><br>
                <input type="tel" id="tempoCambio" maxlength="3" placeholder="345" style="width:100px; font-size:24px; text-align:center;">
            </div>
            <div id="sub-field" class="grid-giocatori"></div>
            <div class="sub-divider"></div>
            <div id="sub-bench" class="grid-giocatori"></div>
            <button id="btnConfCambio" disabled class="btn-act bg-success full-width" onclick="eseguiCambio()">CONFERMA CAMBIO</button>
            <button class="btn-nav full-width" onclick="chiudiModale('modCambio')">ANNULLA</button>
        </div>
    </div>

    <div id="modSpeciali" class="modal">
        <div class="modal-content">
            <div class="row-quad" style="margin-bottom:15px;">
                <button class="btn-act" id="sTec" onclick="setSpec('T')">TEC</button>
                <button class="btn-act" id="sAnt" onclick="setSpec('U')">ANT</button>
                <button class="btn-act" id="sEsp" onclick="setSpec('D')">ESP</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div id="specNoi"><h4>NOI</h4><div id="specListNoi"></div><button class="btn-nav full-width" onclick="regSpec('PAN','H')">PANCHINA</button></div>
                <div id="specLoro"><h4>LORO</h4><div id="specListLoro"></div><button class="btn-nav full-width" onclick="regSpec('PAN','A')">PANCHINA</button></div>
            </div>
            <button class="btn-nav full-width" style="margin-top:20px;" onclick="chiudiModale('modSpeciali')">CHIUDI</button>
        </div>
    </div>

    <div id="modStats" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div style="display:flex; justify-content: space-between;">
                <h2>STATISTICHE</h2>
                <button onclick="chiudiModale('modStats')" class="btn-danger">X</button>
            </div>
            <div id="statsContent"></div>
            <div class="row-half" style="margin-top:20px;">
                <button class="btn-act bg-success" onclick="exportExcel()">ESPORTA EXCEL</button>
                <button class="btn-act bg-info" onclick="exportPDF()">ESPORTA PDF</button>
            </div>
        </div>
    </div>

    <div id="modTitolari" class="modal">
        <div class="modal-content">
            <h3 id="titoloTit">SELEZIONA 5 TITOLARI</h3>
            <div id="gridTitolari" class="grid-giocatori"></div>
            <button id="btnConfTit" disabled class="btn-act bg-success full-width" onclick="confermaTitolari()">CONFERMA</button>
        </div>
    </div>

    <script>
        // CONFIGURAZIONE FIREBASE (Usa i tuoi dati)
        const firebaseConfig = {
            apiKey: "AIzaSyAtJVAixoUVY3GMhoza7-UBnHMuKjLZjmE",
            authDomain: "basket-reggello-scout.firebaseapp.com",
            databaseURL: "https://basket-reggello-scout-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "basket-reggello-scout",
            storageBucket: "basket-reggello-scout.firebasestorage.app",
            messagingSenderId: "395815946220",
            appId: "1:395815946220:web:68c00b4c7f2da1754722c9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // STATO APPLICAZIONE
        let appState = {
            gameId: "", gameRef: null, noiIsCasa: true, durationQ: 10, durationOT: 5,
            nQ: 1, sH: 0, sA: 0, fH: 0, fA: 0, toH: 0, toA: 0,
            noi: [], loro: [], events: [], inCampo: [], selP: null,
            lastX: 0, lastY: 0, lastVal: 2, currentSpec: 'T',
            players: {} // { num: { pts: 0, foul: 0, t: 0, u: 0, d: 0, mins: 0, lastIn: 600 } }
        };

        // --- INIZIALIZZAZIONE & SETUP ---
        function switchSetup(mode) {
            document.querySelectorAll('#setup > div').forEach(d => d.style.display = 'none');
            if(mode === 'menu') document.getElementById('main-menu').style.display = 'block';
            else document.getElementById('step-'+mode).style.display = 'block';
        }

        function setCasa(val) {
            appState.noiIsCasa = val;
            document.getElementById('btnCasa').style.background = val ? 'var(--success)' : '#444';
            document.getElementById('btnFuori').style.background = !val ? 'var(--success)' : '#444';
        }

        function vaiAConvocati() {
            appState.gameId = document.getElementById('gameId').value.trim();
            if(!appState.gameId) return alert("Inserisci ID Partita");
            
            const listNoi = document.getElementById('list-noi');
            listNoi.innerHTML = "";
            // Per semplicit√† qui simuliamo il manuale, puoi estendere con i Roster salvati
            for(let i=0; i<12; i++) {
                listNoi.innerHTML += `<input type="number" class="manual-num" placeholder="Num" style="width:45px"> <input type="text" class="manual-name" placeholder="Nome" style="width:100px"><br>`;
            }
            switchSetup('convocati');
        }

        function iniziaPartita() {
            // Parsing Giocatori Noi
            document.querySelectorAll('#list-noi br').forEach((_, i) => {
                const num = document.getElementsByClassName('manual-num')[i].value;
                const name = document.getElementsByClassName('manual-name')[i].value;
                if(num) {
                    appState.noi.push({ num, name });
                    appState.players[num] = { pts:0, f:0, t:0, u:0, d:0, mins:0, lastIn: appState.durationQ*60, shots:[] };
                }
            });

            // Parsing Giocatori Loro
            const lText = document.getElementById('list-loro').value.split(/\s+/);
            lText.forEach(n => { if(n) appState.loro.push({ num: n, f: 0 }); });

            document.getElementById('setup').style.display = 'none';
            document.getElementById('gara').style.display = 'block';
            document.getElementById('nameH').innerText = appState.noiIsCasa ? "NOI" : document.getElementById('teamOpp').value;
            document.getElementById('nameA').innerText = !appState.noiIsCasa ? "NOI" : document.getElementById('teamOpp').value;
            document.getElementById('gameCodeDisp').innerText = "CODE: " + appState.gameId;
            appState.gameRef = db.ref('games/' + appState.gameId);
            updateUI();
        }

        // --- LOGICA GARA ---
        function gestioneQuarto() {
            const btn = document.getElementById('btnQ');
            if(btn.innerText.includes("INIZIO")) {
                apriTitolari();
            } else {
                // FINE QUARTO
                if(confirm("Chiudere il Quarto?")) {
                    chiudiQuarto();
                }
            }
        }

        function apriTitolari() {
            const grid = document.getElementById('gridTitolari');
            grid.innerHTML = "";
            appState.noi.forEach(p => {
                const isOut = (appState.players[p.num].f >= 5 || appState.players[p.num].d > 0);
                grid.innerHTML += `<button class="btn-giocatore ${isOut?'out':''}" onclick="toggleTit('${p.num}', this)">${p.num}</button>`;
            });
            apriModale('modTitolari');
        }

        let tempTit = [];
        function toggleTit(num, btn) {
            if(tempTit.includes(num)) {
                tempTit = tempTit.filter(n => n !== num);
                btn.classList.remove('selected');
            } else if(tempTit.length < 5) {
                tempTit.push(num);
                btn.classList.add('selected');
            }
            document.getElementById('btnConfTit').disabled = tempTit.length !== 5;
        }

        function confermaTitolari() {
            appState.inCampo = [...tempTit];
            appState.inCampo.forEach(n => appState.players[n].lastIn = (appState.nQ > 4 ? appState.durationOT : appState.durationQ) * 60);
            tempTit = [];
            chiudiModale('modTitolari');
            document.getElementById('panelAzioni').style.opacity = "1";
            document.getElementById('panelAzioni').style.pointerEvents = "auto";
            document.getElementById('btnQ').innerText = "FINE Q" + appState.nQ;
            document.getElementById('btnQ').classList.replace('bg-success', 'bg-danger');
            updateUI();
        }

        function chiudiQuarto() {
            // Calcolo minuti finali quarto
            appState.inCampo.forEach(n => {
                appState.players[n].mins += appState.players[n].lastIn; 
            });
            
            appState.fH = 0; appState.fA = 0;
            if(appState.nQ === 2) { appState.toH = 0; appState.toA = 0; } // Reset TO FIBA
            
            appState.nQ++;
            document.getElementById('btnQ').innerText = "INIZIO Q" + appState.nQ;
            document.getElementById('btnQ').classList.replace('bg-danger', 'bg-success');
            document.getElementById('panelAzioni').style.opacity = "0.3";
            document.getElementById('panelAzioni').style.pointerEvents = "none";
            appState.inCampo = [];
            updateUI();
            cloudSave();
        }

        // --- AZIONI ---
        function gestisciToccoCampo(e) {
            const rect = document.getElementById('mappaTiro').getBoundingClientRect();
            appState.lastX = e.clientX - rect.left;
            appState.lastY = e.clientY - rect.top;
            
            const dist = Math.sqrt(Math.pow(appState.lastX - 150, 2) + Math.pow(appState.lastY - 30, 2));
            appState.lastVal = (dist > 135 || (appState.lastY < 30 && (appState.lastX < 15 || appState.lastX > 285))) ? 3 : 2;
            document.getElementById('infoTiro').innerText = "Tiro da " + appState.lastVal;
            
            // Marker temporaneo
            document.querySelectorAll('.shot-temp').forEach(d => d.remove());
            const dot = document.createElement('div');
            dot.className = 'shot-dot shot-temp';
            dot.style.left = appState.lastX + 'px';
            dot.style.top = appState.lastY + 'px';
            dot.style.background = 'white';
            document.getElementById('mappaTiro').appendChild(dot);
        }

        function regEsitoTiro(success) {
            const p = appState.players[appState.selP];
            if(success) {
                p.pts += appState.lastVal;
                if(appState.noiIsCasa) appState.sH += appState.lastVal; else appState.sA += appState.lastVal;
                doFlash('green');
            }
            p.shots.push({ x: appState.lastX, y: appState.lastY, val: appState.lastVal, ok: success, q: appState.nQ });
            logEvento(`Tiro ${appState.lastVal}`, appState.selP, success?'OK':'X');
            chiudiModale('modTiro');
            updateUI();
        }

        function regFalloFatto() {
            if(!appState.selP) return;
            const p = appState.players[appState.selP];
            p.f++;
            if(appState.noiIsCasa) appState.fH++; else appState.fA++;
            doFlash('red');
            logEvento("Fallo Fatto", appState.selP, p.f+"¬∞");
            if(p.f >= 5) { apriCambio(); }
            updateUI();
        }

        // --- CAMBI ---
        function apriCambio() {
            const field = document.getElementById('sub-field');
            const bench = document.getElementById('sub-bench');
            field.innerHTML = ""; bench.innerHTML = "";
            tempOut = []; tempIn = [];
            
            appState.noi.forEach(p => {
                const data = appState.players[p.num];
                const isOut = (data.f >= 5 || data.d > 0);
                const btn = `<button class="btn-giocatore ${isOut?'out':''}" onclick="selectSub('${p.num}', this)">${p.num}</button>`;
                if(appState.inCampo.includes(p.num)) field.innerHTML += btn;
                else if(!isOut) bench.innerHTML += btn;
            });
            apriModale('modCambio');
        }

        let tempOut = [], tempIn = [];
        function selectSub(num, btn) {
            if(appState.inCampo.includes(num)) {
                if(tempOut.includes(num)) { tempOut = tempOut.filter(n=>n!==num); btn.classList.remove('active-out'); }
                else { tempOut.push(num); btn.classList.add('active-out'); }
            } else {
                if(tempIn.includes(num)) { tempIn = tempIn.filter(n=>n!==num); btn.classList.remove('active-in'); }
                else { tempIn.push(num); btn.classList.add('active-in'); }
            }
            const t = document.getElementById('tempoCambio').value;
            document.getElementById('btnConfCambio').disabled = !(tempOut.length === tempIn.length && tempOut.length > 0 && t.length === 3 && parseInt(t.slice(1)) < 60);
        }

        function eseguiCambio() {
            const t = document.getElementById('tempoCambio').value;
            const secRimanenti = (parseInt(t[0]) * 60) + parseInt(t.slice(1));
            
            tempOut.forEach(n => {
                appState.players[n].mins += (appState.players[n].lastIn - secRimanenti);
                appState.inCampo = appState.inCampo.filter(x => x !== n);
            });
            tempIn.forEach(n => {
                appState.players[n].lastIn = secRimanenti;
                appState.inCampo.push(n);
            });
            logEvento("Cambio", tempOut.join(','), "per "+tempIn.join(','));
            chiudiModale('modCambio');
            updateUI();
        }

        // --- UTILITY ---
        function doFlash(c) { document.body.className = 'flash-'+c; setTimeout(()=>document.body.className='', 150); }
        
        function logEvento(a, p, e) {
            appState.events.push({ q: appState.nQ, p, a, e, ts: Date.now() });
            cloudSave();
        }

        function updateUI() {
            document.getElementById('scoreH').innerText = appState.sH;
            document.getElementById('scoreA').innerText = appState.sA;
            document.getElementById('fTeamH').innerText = appState.fH;
            document.getElementById('fTeamA').innerText = appState.fA;
            document.getElementById('bonusH').classList.toggle('active', appState.fH >= 5);
            document.getElementById('bonusA').classList.toggle('active', appState.fA >= 5);
            document.getElementById('labelQ').innerText = "Q" + appState.nQ;
            
            // Update Grid Noi
            const grid = document.getElementById('gridGara');
            grid.innerHTML = "";
            appState.noi.forEach(p => {
                const d = appState.players[p.num];
                const isField = appState.inCampo.includes(p.num);
                const isOut = (d.f >= 5 || d.d > 0);
                const spec = (d.t>0?`T${d.t}`:'') + (d.u>0?`U${d.u}`:'') + (d.d>0?'D':'');
                grid.innerHTML += `
                    <button class="btn-giocatore ${isField?'in-campo':''} ${appState.selP==p.num?'selected':''} ${isOut?'out':''}" 
                        onclick="setSel('${p.num}')">
                        <span class="p-name">${p.name}</span>
                        <span class="p-num">${p.num}</span>
                        <span class="p-pts">${d.pts}</span>
                        <span class="p-foul">${d.f}</span>
                        <span class="p-special">${spec}</span>
                    </button>`;
            });
        }

        function setSel(n) { appState.selP = (appState.selP === n) ? null : n; updateUI(); }
        function apriModale(id) { document.getElementById(id).style.display = 'flex'; }
        function chiudiModale(id) { document.getElementById(id).style.display = 'none'; }
        function cloudSave() { if(appState.gameRef) appState.gameRef.set(appState); }

        function regQuick(a, c) { if(!appState.selP) return; doFlash(c); logEvento(a, appState.selP, "-"); updateUI(); }
        function puntiAvv(v) { if(appState.noiIsCasa) appState.sA += v; else appState.sH += v; updateUI(); logEvento("Punti Avv", "AVV", "+"+v); }

        // --- EXPORT & STATS (Abbozzo funzionale) ---
        function mostraStatistiche() {
            let html = `<table style="width:100%; text-align:center; border-collapse:collapse;">
                <tr style="border-bottom:1px solid #666"><th>#</th><th>PTS</th><th>FALLI</th><th>MIN</th></tr>`;
            appState.noi.forEach(p => {
                const d = appState.players[p.num];
                const m = Math.floor(d.mins / 60);
                const s = d.mins % 60;
                html += `<tr style="border-bottom:1px solid #333; padding:10px 0;">
                    <td><b>${p.num}</b></td><td>${d.pts}</td><td>${d.f}</td><td>${m}:${s.toString().padStart(2,'0')}</td>
                </tr>`;
            });
            html += `</table>`;
            document.getElementById('statsContent').innerHTML = html;
            apriModale('modStats');
        }

        function exportExcel() {
            const data = appState.noi.map(p => ({
                Numero: p.num,
                Nome: p.name,
                Punti: appState.players[p.num].pts,
                Falli: appState.players[p.num].f,
                Minuti: Math.floor(appState.players[p.num].mins / 60) + ":" + (appState.players[p.num].mins % 60)
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Stats");
            XLSX.writeFile(wb, `Scout_${appState.gameId}.xlsx`);
        }

        // Funzione Undo (Semplificata: rimuove l'ultimo evento)
        function undo() {
            if(appState.events.length === 0) return;
            const last = appState.events.pop();
            // Logica di ricalcolo inverso (qui andrebbe implementato il rollback di ogni statistica)
            alert("Undo azione: " + last.a + ". Nota: ricalcolo completo richiesto.");
            updateUI();
        }

        // Inizializzazione automatica
        (function init() {
            // Qui potresti caricare i roster da localStorage
        })();

    </script>
</body>
</html>
