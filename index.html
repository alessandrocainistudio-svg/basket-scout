<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Basket Scout Pro - Final</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* STILI CSS */
        :root { --bg: #121212; --surf: #1e1e1e; --prim: #ffeb3b; --err: #dc3545; --succ: #28a745; --info: #007bff; --warn: #ff9800; --text: #fff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; overflow-x:hidden; touch-action: manipulation; }
        
        /* Reset e Base */
        button { cursor: pointer; border: none; font-weight: bold; border-radius: 6px; text-transform: uppercase; }
        input, select, textarea { background: #333; color: #fff; border: 1px solid #555; padding: 10px; width: 100%; box-sizing: border-box; margin: 5px 0; border-radius: 4px; }
        
        /* Utility Classi */
        .hidden { display: none !important; }
        .row { display: flex; gap: 8px; margin-bottom: 8px; }
        .full { width: 100%; }
        .btn-l { padding: 15px; font-size: 14px; }
        
        /* Colori */
        .bg-prim { background: var(--prim); color: #000; }
        .bg-sec { background: #444; color: #fff; }
        .bg-succ { background: var(--succ); color: #fff; }
        .bg-err { background: var(--err); color: #fff; }
        .bg-info { background: var(--info); color: #fff; }
        .bg-warn { background: var(--warn); color: #000; }

        /* Scoreboard */
        .scoreboard { display: grid; grid-template-columns: 1.2fr 1fr 1.2fr; background: #000; padding: 10px; border: 1px solid #333; border-radius: 8px; text-align: center; margin-bottom: 10px; }
        .score { font-size: 40px; margin: 0; color: var(--prim); }
        .bonus { font-size: 10px; background: var(--warn); color: #000; padding: 2px 4px; border-radius: 4px; visibility: hidden; }
        .bonus.active { visibility: visible; }
        .to-dots { display: flex; justify-content: center; gap: 4px; margin-top: 5px; }
        .dot { width: 8px; height: 8px; background: #333; border-radius: 50%; }
        .dot.active { background: var(--err); }

        /* Griglia Giocatori */
        .grid-p { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .p-card { background: var(--surf); border: 2px solid #444; padding: 10px 5px; border-radius: 8px; position: relative; height: 75px; color: #fff; }
        .p-card.on-court { border-color: var(--succ); box-shadow: inset 0 0 5px var(--succ); }
        .p-card.selected { background: var(--warn); color: #000; }
        .p-card.out { opacity: 0.4; pointer-events: none; }
        .p-num { font-size: 24px; display: block; text-align: center; }
        .p-name { font-size: 10px; position: absolute; top: 5px; left: 5px; right: 5px; text-align: center; white-space: nowrap; overflow: hidden; }
        .p-stat-pts { position: absolute; bottom: 5px; left: 5px; color: #7fff7f; font-size: 12px; font-weight: bold; }
        .p-stat-f { position: absolute; bottom: 5px; right: 5px; background: var(--err); padding: 1px 5px; border-radius: 4px; font-size: 12px; }
        .p-icon { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); font-size: 10px; color: cyan; font-weight: bold; }

        /* Azioni */
        .actions-grid { display: grid; gap: 8px; }
        .act-row-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; }
        .act-row-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; }

        /* Modali */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 999; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 10px; box-sizing: border-box; }
        .modal-content { background: var(--surf); width: 100%; max-width: 500px; padding: 15px; border-radius: 10px; border: 1px solid #444; margin-top: 20px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        
        /* Mappa Campo */
        #court-map { width: 300px; height: 260px; background: #d2a679; margin: 0 auto; position: relative; border: 2px solid #fff; border-radius: 4px; overflow: hidden; }
        .c-rim { position: absolute; top: 35px; left: 150px; width: 12px; height: 12px; border: 2px solid #e65100; border-radius: 50%; transform: translate(-50%,-50%); }
        .c-3pt { position: absolute; top: -80px; left: 20px; width: 260px; height: 240px; border: 2px solid #fff; border-radius: 0 0 130px 130px; pointer-events: none; }
        .c-paint { position: absolute; top: 0; left: 110px; width: 80px; height: 120px; border: 2px solid #fff; pointer-events: none; }
        .shot-mark { position: absolute; width: 10px; height: 10px; background: #fff; border-radius: 50%; transform: translate(-50%,-50%); border: 1px solid #000; }

        /* Flash */
        @keyframes flashAnim { 0% { opacity: 0.8; } 100% { opacity: 0; } }
        .flash-overlay { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 2000; opacity: 0; }
        .flash-active { animation: flashAnim 0.3s ease-out; }

        /* Roster Items */
        .roster-row { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 8px; margin-bottom: 5px; border-radius: 4px; }
        .check-player { display: flex; align-items: center; background: #222; padding: 10px; border-bottom: 1px solid #333; }
        .check-player input { width: auto; margin-right: 10px; }
    </style>
</head>
<body>

    <div id="flash" class="flash-overlay"></div>

    <div id="view-home">
        <h1 style="text-align: center; color: var(--prim);">BASKET SCOUT PRO</h1>
        <button class="btn-l bg-info full" onclick="nav('view-new')">NUOVA PARTITA</button><br><br>
        <button class="btn-l bg-warn full" onclick="loadGamePrompt()">CARICA PARTITA</button><br><br>
        <button class="btn-l bg-sec full" onclick="nav('view-roster'); loadRosters();">GESTIONE ROSTER</button>
    </div>

    <div id="view-roster" class="hidden">
        <div class="modal-header"><h3>GESTIONE SQUADRE</h3><button onclick="nav('view-home')">X</button></div>
        <div class="row">
            <input type="text" id="new-team-name" placeholder="Nome Squadra">
            <button class="bg-prim" style="width: 80px;" onclick="createTeam()">CREA</button>
        </div>
        <div id="roster-list"></div>
    </div>

    <div id="mod-edit-roster" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="edit-title">MODIFICA</h3><button onclick="closeModal('mod-edit-roster')">X</button></div>
            <div id="edit-players-container" style="max-height: 300px; overflow-y: scroll;"></div>
            <button class="btn-l bg-info full" style="margin-top:10px;" onclick="addEditRow()">+ AGGIUNGI GIOCATORE</button>
            <button class="btn-l bg-succ full" style="margin-top:10px;" onclick="saveRosterChanges()">SALVA</button>
        </div>
    </div>

    <div id="view-new" class="hidden">
        <div class="modal-header"><h3>SETUP PARTITA</h3><button onclick="nav('view-home')">X</button></div>
        <input type="text" id="setup-code" placeholder="CODICE PARTITA (es. Gara1)">
        
        <label>MIA SQUADRA:</label>
        <select id="setup-roster-sel" onchange="checkManualInput(this.value)"><option value="">Seleziona...</option><option value="MANUAL">MANUALE (Inserisci dopo)</option></select>
        
        <label>AVVERSARI:</label>
        <input type="text" id="setup-opp-name" placeholder="Nome Avversario">
        <div class="row">
            <button id="btn-home" class="full bg-sec" onclick="setHome(true)">CASA</button>
            <button id="btn-away" class="full bg-sec" onclick="setHome(false)">FUORI</button>
        </div>

        <label>TEMPO:</label>
        <div class="row">
            <select id="setup-mins"><option value="10">10 Min/Q</option><option value="8">8 Min/Q</option></select>
            <select id="setup-ot"><option value="5">5 Min OT</option></select>
        </div>

        <button class="btn-l bg-succ full" style="margin-top: 15px;" onclick="goToConvocazioni()">AVANTI ></button>
    </div>

    <div id="view-conv" class="hidden">
        <h3>CONVOCAZIONI</h3>
        <div class="row">
            <div class="full">
                <h4>NOI (Seleziona)</h4>
                <div id="conv-list-noi" style="height: 200px; overflow-y: auto; background: #222; padding: 5px;"></div>
            </div>
            <div class="full">
                <h4>LORO (Numeri)</h4>
                <textarea id="conv-list-loro" placeholder="Es: 4 5 10 23 (spaziati)" style="height: 200px;"></textarea>
            </div>
        </div>
        <button class="btn-l bg-prim full" onclick="startGame()">VAI ALLA PARTITA üèÄ</button>
    </div>

    <div id="view-game" class="hidden">
        <div class="scoreboard">
            <div>
                <small id="l-home">HOME</small>
                <h1 class="score" id="s-home">0</h1>
                <div style="color:red">FALLI: <span id="f-home">0</span></div>
                <div id="b-home" class="bonus">BONUS</div>
                <div class="to-dots" id="to-home"></div>
                <button style="font-size:10px; margin-top:2px;" onclick="addTimeOut('H')">TIMEOUT</button>
            </div>
            <div>
                <div style="color:var(--prim); font-weight:bold; font-size:22px;" id="q-disp">Q1</div>
                <div style="font-size:10px; color:#666;" id="code-disp"></div>
                <button id="btn-q" class="bg-succ" style="padding: 5px 15px; margin-top:5px;" onclick="handleQuarter()">INIZIO Q1</button>
            </div>
            <div>
                <small id="l-away">AWAY</small>
                <h1 class="score" id="s-away">0</h1>
                <div style="color:red">FALLI: <span id="f-away">0</span></div>
                <div id="b-away" class="bonus">BONUS</div>
                <div class="to-dots" id="to-away"></div>
                <button style="font-size:10px; margin-top:2px;" onclick="addTimeOut('A')">TIMEOUT</button>
            </div>
        </div>

        <div class="act-row-4" style="margin-bottom:10px;">
            <button class="bg-sec" style="color:#ff9999" onclick="addOppPoint(1)">+1 AVV</button>
            <button class="bg-sec" style="color:#ff9999" onclick="addOppPoint(2)">+2 AVV</button>
            <button class="bg-sec" style="color:#ff9999" onclick="addOppPoint(3)">+3 AVV</button>
            <button class="bg-info" onclick="openFalliMod()">SIT. FALLI</button>
        </div>

        <div id="grid-players" class="grid-p"></div>

        <div id="actions-panel" style="opacity: 0.3; pointer-events: none;">
            <div class="act-row-2">
                <button class="btn-l bg-prim" onclick="openShotMap()">üèÄ TIRO</button>
                <button class="btn-l bg-sec" onclick="openFT()">LIBERI</button>
            </div>
            <div class="row">
                <button class="btn-l bg-err full" onclick="addFoul(true)">üõë FALLO FATTO</button>
                <button class="btn-l bg-succ full" onclick="openFoulSub()">ü§ù SUBITO</button>
            </div>
            <div class="act-row-4">
                <button class="bg-info" onclick="addStat('RD')">R.DIF</button>
                <button class="bg-info" onclick="addStat('RO')">R.OFF</button>
                <button class="bg-err" onclick="addStat('PP')">PERSA</button>
                <button class="bg-succ" onclick="addStat('PR')">RECUP</button>
            </div>
            <div class="row" style="margin-top:8px;">
                <button class="btn-l bg-sec full" onclick="openSub()">üîÑ CAMBIO</button>
            </div>
            <div class="row">
                <button class="bg-warn full" style="padding: 8px;" onclick="openSpecials()">‚ö†Ô∏è FALLI SPECIALI</button>
            </div>
        </div>

        <div class="act-row-4" style="margin-top: 15px;">
            <button class="bg-sec" onclick="undoLast()">‚Ü©Ô∏è UNDO</button>
            <button class="bg-sec" onclick="openEvents()">üìú EVENTI</button>
            <button class="bg-sec" onclick="calcStats(); openModal('mod-stats');">üìä STATS</button>
        </div>
    </div>

    <div id="mod-shot" class="modal">
        <div class="modal-content">
            <h3 id="shot-title">TIRO</h3>
            <div id="court-map" onclick="mapClick(event)">
                <div class="c-rim"></div><div class="c-3pt"></div><div class="c-paint"></div>
            </div>
            <div class="row" style="margin-top:10px;">
                <button class="btn-l bg-succ full" onclick="confirmShot(true)">SEGNATO</button>
                <button class="btn-l bg-err full" onclick="confirmShot(false)">SBAGLIATO</button>
            </div>
            <button class="full bg-sec" style="padding:10px;" onclick="closeModal('mod-shot')">ANNULLA</button>
        </div>
    </div>

    <div id="mod-sub" class="modal">
        <div class="modal-content">
            <h3>CAMBIO</h3>
            <div style="text-align: center; margin-bottom: 10px;">
                <label>Tempo Residuo (MSS, es: 430 = 4:30)</label>
                <input type="number" id="sub-time" placeholder="MSS" style="font-size:20px; text-align:center; width: 100px;">
            </div>
            <div style="border-bottom: 2px solid #555; padding-bottom: 5px; margin-bottom: 5px;">IN CAMPO (Chi esce)</div>
            <div id="sub-list-in" class="grid-p"></div>
            <div style="border-bottom: 2px solid #555; padding-bottom: 5px; margin-bottom: 5px; margin-top:15px;">PANCHINA (Chi entra)</div>
            <div id="sub-list-out" class="grid-p"></div>
            <button id="btn-conf-sub" class="btn-l bg-succ full" disabled onclick="execSub()">CONFERMA</button>
            <button class="full bg-sec" style="margin-top:5px; padding:10px;" onclick="closeModal('mod-sub')">CHIUDI</button>
        </div>
    </div>

    <div id="mod-stats" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header"><h3>STATISTICHE</h3><button onclick="closeModal('mod-stats')">X</button></div>
            <div id="stats-body" style="overflow-x: auto;"></div>
            <div class="row" style="margin-top:15px;">
                <button class="btn-l bg-succ full" onclick="exportXLSX()">EXCEL</button>
                <button class="btn-l bg-err full" onclick="exportPDF()">PDF</button>
            </div>
        </div>
    </div>

    <div id="mod-spec" class="modal">
        <div class="modal-content">
            <h3>FALLI SPECIALI</h3>
            <div class="act-row-4">
                <button class="btn-l" id="sp-T" onclick="selSpType('T')">TEC</button>
                <button class="btn-l" id="sp-U" onclick="selSpType('U')">ANT</button>
                <button class="btn-l" id="sp-D" onclick="selSpType('D')">ESP</button>
            </div>
            <hr>
            <h4>ASSEGNA A:</h4>
            <div id="spec-players" class="grid-p"></div>
            <button class="btn-l bg-sec full" style="margin-top:5px;" onclick="assignSpec('BENCH')">PANCHINA</button>
            <button class="full bg-sec" style="margin-top:10px; padding:10px;" onclick="closeModal('mod-spec')">CHIUDI</button>
        </div>
    </div>

    <div id="mod-starters" class="modal">
        <div class="modal-content">
            <h3>QUINTETTO BASE</h3>
            <div id="list-starters" class="grid-p"></div>
            <button id="btn-conf-start" class="btn-l bg-succ full" disabled onclick="confirmStarters()">CONFERMA</button>
        </div>
    </div>

    <div id="mod-events" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>LOG EVENTI</h3><button onclick="closeModal('mod-events')">X</button></div>
            <div id="events-list" style="max-height: 300px; overflow-y: scroll;"></div>
        </div>
    </div>

    <div id="mod-ft" class="modal">
        <div class="modal-content">
            <h3>TIRI LIBERI</h3>
            <div id="ft-seq" style="font-size:30px; text-align:center; min-height:40px; margin-bottom:10px;"></div>
            <div class="row">
                <button class="btn-l bg-succ full" onclick="regFT(true)">REALIZZATO</button>
                <button class="btn-l bg-err full" onclick="regFT(false)">SBAGLIATO</button>
            </div>
            <button class="full bg-sec" style="margin-top:10px; padding:10px;" onclick="closeModal('mod-ft')">FINE</button>
        </div>
    </div>

    <div id="mod-foul-sit" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>SITUAZIONE FALLI</h3><button onclick="closeModal('mod-foul-sit')">X</button></div>
            <div class="row">
                <div class="full" id="fs-noi"></div>
                <div class="full" id="fs-loro"></div>
            </div>
        </div>
    </div>

    <div id="mod-foul-sub" class="modal">
        <div class="modal-content">
            <h3>FALLO SUBITO DA:</h3>
            <div id="fs-opp-list" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:5px;"></div>
            <hr>
            <div class="row">
                <button class="btn-l bg-info full" onclick="closeModal('mod-foul-sub')">RIMESSA</button>
                <button class="btn-l bg-succ full" onclick="closeModal('mod-foul-sub'); openFT();">TIRI LIBERI</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURAZIONE E INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyAtJVAixoUVY3GMhoza7-UBnHMuKjLZjmE",
            authDomain: "basket-reggello-scout.firebaseapp.com",
            databaseURL: "https://basket-reggello-scout-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "basket-reggello-scout",
            storageBucket: "basket-reggello-scout.firebasestorage.app",
            messagingSenderId: "395815946220",
            appId: "1:395815946220:web:68c00b4c7f2da1754722c9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Stato Globale
        let g = {
            id: null, ref: null, home: true, q: 1, minQ: 10, minOT: 5,
            sH: 0, sA: 0, fH: 0, fA: 0, tH: 0, tA: 0,
            players: {}, // { "10": { name, pts, f, t, u, d, min, lastIn, shots:[] } }
            opp: [], // [{n:4, f:0}]
            events: [], // [{id, q, type, p, desc, val}]
            onCourt: [], // ["10", "11"...]
            sel: null, // Giocatore selezionato
            rosters: {},
            specType: null
        };

        // --- 2. NAVIGAZIONE ---
        function nav(id) {
            document.querySelectorAll('body > div').forEach(d => {
                if(d.id !== 'flash' && !d.classList.contains('modal')) d.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- 3. ROSTER MANAGER ---
        function loadRosters() {
            db.ref('rosters').on('value', snap => {
                g.rosters = snap.val() || {};
                renderRosterList();
                // Popola select setup
                const sel = document.getElementById('setup-roster-sel');
                sel.innerHTML = '<option value="">Seleziona...</option><option value="MANUAL">MANUALE</option>';
                Object.keys(g.rosters).forEach(k => {
                    sel.innerHTML += `<option value="${k}">${k}</option>`;
                });
            });
        }

        function createTeam() {
            const name = document.getElementById('new-team-name').value.trim();
            if(!name) return;
            db.ref('rosters/'+name).set({ created: Date.now(), players: [] });
            document.getElementById('new-team-name').value = "";
        }

        function renderRosterList() {
            const div = document.getElementById('roster-list');
            div.innerHTML = "";
            Object.keys(g.rosters).forEach(k => {
                div.innerHTML += `
                <div class="roster-row">
                    <span><b>${k}</b> (${(g.rosters[k].players||[]).length} gioc.)</span>
                    <div>
                        <button class="bg-info" style="padding:5px;" onclick="openEditRoster('${k}')">EDIT</button>
                        <button class="bg-err" style="padding:5px;" onclick="delTeam('${k}')">DEL</button>
                    </div>
                </div>`;
            });
        }

        let editTeamName = null;
        function openEditRoster(name) {
            editTeamName = name;
            document.getElementById('edit-title').innerText = "EDIT: " + name;
            const pl = g.rosters[name].players || [];
            const cont = document.getElementById('edit-players-container');
            cont.innerHTML = "";
            pl.forEach(p => addEditRow(p.n, p.name));
            openModal('mod-edit-roster');
        }

        function addEditRow(n="", name="") {
            const div = document.createElement('div');
            div.className = "row";
            div.innerHTML = `
                <input type="number" class="ed-n" placeholder="N" value="${n}" style="width:60px;">
                <input type="text" class="ed-name" placeholder="Nome" value="${name}">
                <button class="bg-err" onclick="this.parentElement.remove()">X</button>
            `;
            document.getElementById('edit-players-container').appendChild(div);
        }

        function saveRosterChanges() {
            const rows = document.getElementById('edit-players-container').children;
            const arr = [];
            for(let r of rows) {
                const n = r.querySelector('.ed-n').value;
                const name = r.querySelector('.ed-name').value;
                if(n) arr.push({n, name});
            }
            db.ref('rosters/'+editTeamName+'/players').set(arr);
            closeModal('mod-edit-roster');
        }

        function delTeam(n) { if(confirm("Eliminare "+n+"?")) db.ref('rosters/'+n).remove(); }

        // --- 4. SETUP PARTITA ---
        function setHome(isHome) {
            g.home = isHome;
            document.getElementById('btn-home').style.background = isHome ? 'var(--succ)' : '#444';
            document.getElementById('btn-away').style.background = !isHome ? 'var(--succ)' : '#444';
        }

        function checkManualInput(val) {
            // Logica se manuale (non necessario implementare extra UI ora, usiamo lista vuota)
        }

        function goToConvocazioni() {
            g.id = document.getElementById('setup-code').value.trim();
            if(!g.id) return alert("Codice mancante");
            
            const rName = document.getElementById('setup-roster-sel').value;
            const listNoi = document.getElementById('conv-list-noi');
            listNoi.innerHTML = "";

            if(rName && rName !== "MANUAL") {
                const pl = g.rosters[rName].players || [];
                pl.forEach(p => {
                    listNoi.innerHTML += `
                    <div class="check-player">
                        <input type="checkbox" value="${p.n}" data-name="${p.name}">
                        <span><b>#${p.n}</b> - ${p.name}</span>
                    </div>`;
                });
            } else {
                // Manuale: 12 slot vuoti
                for(let i=0; i<12; i++) {
                    listNoi.innerHTML += `
                    <div class="check-player">
                        <input type="checkbox" checked value="" class="man-chk">
                        <input type="number" placeholder="#" class="man-n" style="width:50px; margin:0 5px;">
                        <input type="text" placeholder="Nome" class="man-name">
                    </div>`;
                }
            }
            nav('view-conv');
        }

        function startGame() {
            // Init Players Noi
            g.players = {};
            const rName = document.getElementById('setup-roster-sel').value;
            
            if(rName && rName !== "MANUAL") {
                document.querySelectorAll('#conv-list-noi input[type="checkbox"]:checked').forEach(c => {
                    const n = c.value;
                    const name = c.dataset.name;
                    initPlayer(n, name);
                });
            } else {
                document.querySelectorAll('#conv-list-noi .check-player').forEach(d => {
                    if(d.querySelector('.man-chk').checked) {
                        const n = d.querySelector('.man-n').value;
                        const name = d.querySelector('.man-name').value;
                        if(n) initPlayer(n, name);
                    }
                });
            }

            // Init Opponents
            g.opp = [];
            const txt = document.getElementById('conv-list-loro').value;
            txt.split(/[\s,]+/).forEach(n => {
                if(n) g.opp.push({n: n, f: 0});
            });

            // Settings
            g.minQ = parseInt(document.getElementById('setup-mins').value);
            g.minOT = parseInt(document.getElementById('setup-ot').value);
            
            // Labels
            const oppName = document.getElementById('setup-opp-name').value || "OSPITI";
            document.getElementById('l-home').innerText = g.home ? "NOI" : oppName;
            document.getElementById('l-away').innerText = !g.home ? "NOI" : oppName;
            document.getElementById('code-disp').innerText = g.id;

            // DB Init
            g.ref = db.ref('games/' + g.id);
            g.ref.set(g);

            nav('view-game');
            updateUI();
        }

        function initPlayer(n, name) {
            g.players[n] = { n, name, pts:0, f:0, t:0, u:0, d:0, min:0, lastIn: 0, shots:[] };
        }

        function loadGamePrompt() {
            const id = prompt("Codice Partita:");
            if(!id) return;
            db.ref('games/'+id).once('value', s => {
                if(s.exists()) {
                    g = s.val();
                    g.ref = db.ref('games/'+id);
                    nav('view-game');
                    updateUI();
                } else alert("Non trovata");
            });
        }

        // --- 5. LOGICA PARTITA ---
        
        function updateUI() {
            // Scoreboard
            document.getElementById('s-home').innerText = g.sH;
            document.getElementById('s-away').innerText = g.sA;
            document.getElementById('f-home').innerText = g.fH;
            document.getElementById('f-away').innerText = g.fA;
            document.getElementById('b-home').classList.toggle('active', g.fH >= 5);
            document.getElementById('b-away').classList.toggle('active', g.fA >= 5);
            document.getElementById('q-disp').innerText = "Q" + g.q;
            
            // Timeouts
            let dotH = ""; for(let i=0;i<g.tH;i++) dotH += '<div class="dot active"></div>';
            document.getElementById('to-home').innerHTML = dotH;
            let dotA = ""; for(let i=0;i<g.tA;i++) dotA += '<div class="dot active"></div>';
            document.getElementById('to-away').innerHTML = dotA;

            // Grid
            const div = document.getElementById('grid-players');
            div.innerHTML = "";
            Object.values(g.players).sort((a,b)=>parseInt(a.n)-parseInt(b.n)).forEach(p => {
                const onCourt = g.onCourt.includes(p.n);
                const isSel = g.sel === p.n;
                const isOut = (p.f >= 5 || p.d > 0 || (p.t >= 2) || (p.u >= 2) || (p.t+p.u >= 2));
                const specs = (p.t?"T"+p.t:"") + (p.u?"U"+p.u:"") + (p.d?"D":"");
                
                div.innerHTML += `
                <div class="p-card ${onCourt?'on-court':''} ${isSel?'selected':''} ${isOut?'out':''}" onclick="selP('${p.n}')">
                    <span class="p-name">${p.name}</span>
                    <span class="p-num">${p.n}</span>
                    <span class="p-stat-pts">${p.pts}</span>
                    <span class="p-stat-f">${p.f}</span>
                    <span class="p-icon">${specs}</span>
                </div>`;
            });

            // Cloud Save
            if(g.ref) g.ref.set(g);
        }

        function selP(n) {
            if(!g.onCourt.includes(n)) return; // Selezionabile solo se in campo
            g.sel = (g.sel === n) ? null : n;
            updateUI();
        }

        function flash(c) {
            const f = document.getElementById('flash');
            f.style.backgroundColor = c === 'red' ? 'rgba(255,0,0,0.3)' : (c==='green'?'rgba(0,255,0,0.3)':'rgba(0,0,255,0.3)');
            f.classList.remove('flash-active');
            void f.offsetWidth;
            f.classList.add('flash-active');
        }

        // --- GESTIONE QUARTI E MINUTI ---
        function handleQuarter() {
            const btn = document.getElementById('btn-q');
            if(btn.innerText.includes("INIZIO")) {
                // Apri quintetto
                const lst = document.getElementById('list-starters');
                lst.innerHTML = "";
                tempStart = [];
                Object.values(g.players).forEach(p => {
                    if(!(p.f>=5 || p.d>0)) { // Filtra espulsi
                        lst.innerHTML += `<div class="p-card" id="st-${p.n}" onclick="togStart('${p.n}')"><span class="p-num">${p.n}</span><span class="p-name">${p.name}</span></div>`;
                    }
                });
                document.getElementById('btn-conf-start').disabled = true;
                openModal('mod-starters');
            } else {
                // Fine Quarto
                if(!confirm("Terminare il Quarto?")) return;
                // Calcola minuti finali per chi √® in campo
                const dur = (g.q > 4) ? g.minOT * 60 : g.minQ * 60;
                g.onCourt.forEach(n => {
                    const p = g.players[n];
                    p.min += (p.lastIn - 0); // Hanno giocato fino alla fine (00:00)
                });
                
                // Reset falli squadra e TO se intervallo lungo
                g.fH = 0; g.fA = 0;
                if(g.q === 2) { g.tH = 0; g.tA = 0; }
                
                g.q++;
                g.onCourt = []; // Reset campo
                document.getElementById('btn-q').innerText = "INIZIO Q" + g.q;
                document.getElementById('btn-q').className = "bg-succ";
                document.getElementById('actions-panel').style.opacity = "0.3";
                document.getElementById('actions-panel').style.pointerEvents = "none";
                updateUI();
            }
        }

        let tempStart = [];
        function togStart(n) {
            const div = document.getElementById('st-'+n);
            if(tempStart.includes(n)) {
                tempStart = tempStart.filter(x => x !== n);
                div.classList.remove('selected');
            } else if(tempStart.length < 5) {
                tempStart.push(n);
                div.classList.add('selected');
            }
            document.getElementById('btn-conf-start').disabled = tempStart.length !== 5;
        }

        function confirmStarters() {
            g.onCourt = [...tempStart];
            const dur = (g.q > 4) ? g.minOT * 60 : g.minQ * 60;
            // Setta tempo ingresso all'inizio del quarto
            g.onCourt.forEach(n => g.players[n].lastIn = dur);
            
            document.getElementById('btn-q').innerText = "FINE Q" + g.q;
            document.getElementById('btn-q').className = "bg-err";
            document.getElementById('actions-panel').style.opacity = "1";
            document.getElementById('actions-panel').style.pointerEvents = "auto";
            closeModal('mod-starters');
            updateUI();
        }

        // --- AZIONI DI GIOCO ---
        function addLog(type, val, desc) {
            g.events.push({
                id: Date.now(), q: g.q, p: g.sel, type, val, desc, 
                score: {h: g.sH, a: g.sA} // snapshot punteggio
            });
        }

        function openShotMap() { if(!g.sel) return; openModal('mod-shot'); }
        let lastShot = {x:0, y:0, val:2};
        
        function mapClick(e) {
            const rect = document.getElementById('court-map').getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Logica distanza 3 punti (semplificata)
            const dx = x - 150; const dy = y - 35;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const val = (dist > 120) ? 3 : 2; // soglia pixel
            
            lastShot = {x, y, val};
            
            // Visual
            const m = document.createElement('div');
            m.className = "shot-mark";
            m.style.left = x+"px"; m.style.top = y+"px";
            document.getElementById('court-map').appendChild(m);
            setTimeout(()=>m.remove(), 1000);
            document.getElementById('shot-title').innerText = "TIRO DA " + val;
        }

        function confirmShot(made) {
            const p = g.players[g.sel];
            if(made) {
                p.pts += lastShot.val;
                if(g.home) g.sH += lastShot.val; else g.sA += lastShot.val;
                flash('green');
            }
            p.shots.push({ ...lastShot, made, q: g.q });
            addLog("TIRO", made?lastShot.val:0, made?"Segnato":"Sbagliato");
            closeModal('mod-shot');
            updateUI();
        }

        function openFT() { document.getElementById('ft-seq').innerHTML=""; openModal('mod-ft'); }
        function regFT(made) {
            const div = document.getElementById('ft-seq');
            div.innerHTML += made ? '<span style="color:lime">O </span>' : '<span style="color:red">X </span>';
            if(g.sel) {
                const p = g.players[g.sel];
                if(made) {
                    p.pts += 1;
                    if(g.home) g.sH += 1; else g.sA += 1;
                }
                // Nota: salviamo statistica FT generica o dettagliata a piacere
                addLog("TL", made?1:0, made?"Segnato":"Sbagliato");
                updateUI();
            }
        }

        function addFoul(isFoul) {
            if(!g.sel) return;
            const p = g.players[g.sel];
            p.f++;
            if(g.home) g.fH++; else g.fA++;
            flash('red');
            addLog("FALLO", 0, p.f+"¬∞ Pers");
            if(p.f >= 5) openSub();
            updateUI();
        }

        function openFoulSub() {
            const list = document.getElementById('fs-opp-list');
            list.innerHTML = "";
            g.opp.forEach(o => {
                list.innerHTML += `<button class="bg-sec" style="padding:10px" onclick="selOppFoul('${o.n}')">#${o.n}<br><small>${o.f} falli</small></button>`;
            });
            openModal('mod-foul-sub');
        }

        function selOppFoul(n) {
            const o = g.opp.find(x => x.n == n);
            o.f++;
            if(!g.home) g.fH++; else g.fA++; // Fallo avversario aumenta falli LORO
            updateUI();
        }

        function addStat(type) {
            if(!g.sel) return;
            flash('blue');
            addLog(type, 0, type);
            // Qui potresti incrementare contatori specifici nel player object se servono
            updateUI();
        }

        function addOppPoint(val) {
            if(g.home) g.sA += val; else g.sH += val;
            addLog("PUNTI_AVV", val, "+"+val);
            updateUI();
        }
        
        function addTimeOut(team) {
            if(team === 'H') g.tH++; else g.tA++;
            updateUI();
        }

        // --- GESTIONE CAMBI ---
        let subOut = [], subIn = [];
        function openSub() {
            const listIn = document.getElementById('sub-list-in');
            const listOut = document.getElementById('sub-list-out');
            listIn.innerHTML = ""; listOut.innerHTML = "";
            subOut = []; subIn = [];

            Object.values(g.players).forEach(p => {
                const isOut = (p.f >= 5 || p.d > 0 || (p.t+p.u >= 2));
                const div = document.createElement('div');
                div.className = `p-card ${isOut?'out':''}`;
                div.innerHTML = `<span class="p-num">${p.n}</span>`;
                div.onclick = () => toggleSub(p.n, div, g.onCourt.includes(p.n));
                
                if(g.onCourt.includes(p.n)) listIn.appendChild(div);
                else listOut.appendChild(div);
            });
            openModal('mod-sub');
        }

        function toggleSub(n, div, isCourt) {
            if(isCourt) {
                if(subOut.includes(n)) { subOut = subOut.filter(x=>x!==n); div.classList.remove('selected'); }
                else { subOut.push(n); div.classList.add('selected'); }
            } else {
                if(subIn.includes(n)) { subIn = subIn.filter(x=>x!==n); div.classList.remove('selected'); }
                else { subIn.push(n); div.classList.add('selected'); }
            }
            // Validazione
            const t = document.getElementById('sub-time').value;
            const validT = t.length >= 3 && parseInt(t.slice(-2)) < 60;
            document.getElementById('btn-conf-sub').disabled = !(subIn.length === subOut.length && subIn.length > 0 && validT);
        }

        function execSub() {
            const tStr = document.getElementById('sub-time').value; // es 430
            const sec = parseInt(tStr.slice(0, -2)) * 60 + parseInt(tStr.slice(-2));
            
            subOut.forEach(n => {
                const p = g.players[n];
                p.min += (p.lastIn - sec); // Ha giocato da lastIn fino a ora
                g.onCourt = g.onCourt.filter(x => x !== n);
            });
            
            subIn.forEach(n => {
                const p = g.players[n];
                p.lastIn = sec; // Entra ora
                g.onCourt.push(n);
            });
            
            addLog("CAMBIO", 0, `OUT:${subOut} IN:${subIn}`);
            closeModal('mod-sub');
            updateUI();
        }

        // --- FALLI SPECIALI ---
        function openSpecials() {
            g.specType = null;
            document.querySelectorAll('#mod-spec button').forEach(b => b.classList.remove('bg-warn'));
            // Render Players
            const d = document.getElementById('spec-players');
            d.innerHTML = "";
            Object.values(g.players).forEach(p => {
                d.innerHTML += `<div class="p-card" onclick="assignSpec('${p.n}')"><span class="p-num">${p.n}</span></div>`;
            });
            openModal('mod-spec');
        }
        
        function selSpType(t) {
            g.specType = t;
            // Highlight button...
        }

        function assignSpec(target) {
            if(!g.specType) return alert("Seleziona tipo fallo");
            if(target === 'BENCH') {
                // Fallo panchina (non conta falli squadra o personali solitamente, o logica custom)
                addLog("SPECIALE", 0, "Panchina "+g.specType);
            } else {
                const p = g.players[target];
                if(g.specType === 'T') p.t++;
                if(g.specType === 'U') p.u++;
                if(g.specType === 'D') p.d++;
                p.f++; // Conta come personale
                if(g.home) g.fH++; else g.fA++; // Conta come squadra
                
                addLog("SPECIALE", 0, `${target} ${g.specType}`);
            }
            closeModal('mod-spec');
            updateUI();
        }

        // --- EXPORT & UNDO ---
        function undoLast() {
            if(g.events.length === 0) return;
            const last = g.events.pop();
            // Undo brutale: ricarica ultimo snapshot o revert logica manuale
            // Per semplicit√† qui avvisiamo l'utente che deve correggere i punteggi
            alert("Evento rimosso: " + last.desc + ". Controlla punteggi e falli manualmente.");
            updateUI();
        }

        function openEvents() {
            const l = document.getElementById('events-list');
            l.innerHTML = g.events.map(e => `<div>Q${e.q} - ${e.desc} (${e.p||''})</div>`).reverse().join('');
            openModal('mod-events');
        }

        function openFalliMod() {
            const n = document.getElementById('fs-noi');
            const l = document.getElementById('fs-loro');
            n.innerHTML = "<h4>NOI</h4>" + Object.values(g.players).sort((a,b)=>b.f-a.f).map(p => 
                `<div class="row" style="border-bottom:1px solid #444"><b style="border:1px solid red; padding:2px; color:${p.f>0?'red':'white'}">${p.f}</b>&nbsp;#${p.n} ${p.name}</div>`
            ).join('');
            
            l.innerHTML = "<h4>LORO</h4>" + g.opp.sort((a,b)=>b.f-a.f).map(o => 
                `<div class="row"><b style="border:1px solid red; padding:2px;">${o.f}</b>&nbsp;#${o.n}</div>`
            ).join('');
            openModal('mod-foul-sit');
        }

        function calcStats() {
            const t = document.getElementById('stats-body');
            let h = `<table border="1" style="width:100%; border-collapse:collapse;">
                <tr><th>#</th><th>MIN</th><th>PTS</th><th>F</th></tr>`;
            Object.values(g.players).forEach(p => {
                let m = Math.floor(p.min/60);
                let s = p.min%60;
                h += `<tr><td>${p.n}</td><td>${m}:${s<10?'0'+s:s}</td><td>${p.pts}</td><td>${p.f}</td></tr>`;
            });
            h += "</table>";
            t.innerHTML = h;
        }

        function exportXLSX() {
            const data = Object.values(g.players).map(p => ({
                Numero: p.n, Nome: p.name, Punti: p.pts, Falli: p.f, 
                Minuti: Math.floor(p.min/60)+":"+(p.min%60)
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Stats");
            XLSX.writeFile(wb, "Scout_"+g.id+".xlsx");
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Scout Partita: " + g.id, 10, 10);
            
            const rows = Object.values(g.players).map(p => [
                p.n, p.name, p.pts, p.f, Math.floor(p.min/60)+":"+(p.min%60)
            ]);
            
            doc.autoTable({
                head: [['#', 'Nome', 'PTS', 'Falli', 'Min']],
                body: rows,
                startY: 20
            });
            doc.save("Scout_"+g.id+".pdf");
        }

    </script>
</body>
</html>
