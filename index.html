<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Basket Scout Pro - Full Version</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --bg: #121212; --surface: #1e1e1e; --primary: #ffeb3b; --danger: #dc3545;
            --success: #28a745; --info: #007bff; --warning: #ff9800; --text: #ffffff;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; overflow-x: hidden; touch-action: manipulation; }
        
        /* Notifiche Flash */
        .flash-green { background: #1b5e20 !important; }
        .flash-red { background: #b71c1c !important; }
        .flash-blue { background: #0d47a1 !important; }

        /* Scoreboard */
        .scoreboard { display: grid; grid-template-columns: 1.2fr 1fr 1.2fr; background: #000; padding: 10px; border-radius: 12px; border: 2px solid #333; margin-bottom: 10px; align-items: center; text-align: center; }
        .score-box h1 { font-size: 48px; margin: 0; color: var(--primary); }
        .foul-team { font-size: 16px; color: var(--danger); font-weight: bold; }
        .bonus { color: var(--warning); font-size: 12px; border: 1px solid var(--warning); padding: 2px 5px; border-radius: 4px; visibility: hidden; }
        .bonus.active { visibility: visible; }
        .to-dots { display: flex; justify-content: center; gap: 4px; margin: 5px 0; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #444; }
        .dot.active { background: var(--warning); }

        /* Griglia Giocatori */
        .grid-giocatori { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .btn-giocatore { 
            background: var(--surface); color: white; border: 2px solid #444; border-radius: 12px; 
            padding: 15px 5px; position: relative; font-weight: bold; transition: 0.2s;
        }
        .btn-giocatore.in-campo { border-color: var(--success); box-shadow: inset 0 0 10px rgba(40,167,69,0.2); }
        .btn-giocatore.selected { background: var(--warning) !important; color: black; }
        .btn-giocatore.out { opacity: 0.3; pointer-events: none; }
        .p-name { display: block; font-size: 10px; margin-bottom: 5px; white-space: nowrap; overflow: hidden; }
        .p-num { font-size: 22px; display: block; }
        .p-pts { position: absolute; bottom: 5px; left: 8px; font-size: 12px; color: #7fff7f; }
        .p-foul { position: absolute; bottom: 5px; right: 8px; font-size: 14px; background: var(--danger); padding: 2px 6px; border-radius: 4px; }
        .p-special { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); font-size: 12px; color: cyan; font-weight: bold; }

        /* Pulsanti Azione */
        .actions-container { display: grid; gap: 8px; }
        .row-2-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; }
        .row-half { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .row-quad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .btn-act { padding: 18px 5px; border: none; border-radius: 8px; font-weight: bold; font-size: 13px; text-transform: uppercase; width: 100%; cursor: pointer; }
        .full-width { grid-column: span 2; }

        /* Modali */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; overflow-y: auto; padding: 20px 15px; box-sizing: border-box; }
        .modal-content { background: var(--surface); padding: 20px; border-radius: 15px; border: 1px solid #444; max-width: 500px; margin: auto; width: 100%; }
        input, select { background: #333; border: 1px solid #555; color: white; padding: 12px; border-radius: 6px; margin: 10px 0; width: 100%; box-sizing: border-box; }
        
        /* Mappa Campo */
        #mappaTiro { width: 300px; height: 250px; background: #d2a679; border: 2px solid white; margin: 0 auto; position: relative; border-radius: 5px; overflow: hidden; }
        .canestro { position: absolute; top: 30px; left: 150px; width: 20px; height: 20px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); }
        .area-3pt { position: absolute; top: -100px; left: 15px; width: 270px; height: 260px; border: 2px solid white; border-radius: 0 0 150px 150px; pointer-events: none; }
        .pitturato { position: absolute; top: 0; left: 100px; width: 100px; height: 110px; border: 2px solid white; pointer-events: none; }
        .shot-dot { position: absolute; width: 10px; height: 10px; border-radius: 50%; transform: translate(-50%, -50%); border: 1px solid black; }

        /* Cambi UI */
        .sub-divider { height: 2px; background: #555; margin: 20px 0; position: relative; }
        .sub-divider::after { content: 'BENCH'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--surface); padding: 0 10px; font-size: 10px; color: #888; }
        .active-in { background: var(--success) !important; color: white; }
        .active-out { background: var(--danger) !important; color: white; }
        
        .footer-nav { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .btn-nav { background: #333; color: white; border: none; padding: 12px; border-radius: 6px; font-size: 12px; width: 100%; cursor: pointer; }
    </style>
</head>
<body>
    <div id="setup">
        <h2 style="text-align: center;">BASKET SCOUT PRO üèÄ</h2>
        <div id="main-menu">
            <button class="btn-act" style="background:var(--info); margin-bottom:10px;" onclick="switchSetup('nuova')">NUOVA PARTITA</button>
            <button class="btn-act" style="background:var(--warning); margin-bottom:10px;" onclick="switchSetup('carica')">CARICA PARTITA</button>
            <button class="btn-act" style="background:var(--info);" onclick="switchSetup('roster')">GESTIONE ROSTER</button>
        </div>

        <div id="step-nuova" style="display:none;">
            <button onclick="switchSetup('menu')" style="background:none; color:#aaa; border:none; margin-bottom:10px;">< INDIETRO</button>
            <input type="text" id="gameId" placeholder="CODICE PARTITA">
            <input type="text" id="teamOpp" placeholder="SQUADRA AVVERSARIA">
            <div class="row-half">
                <button id="btnCasa" class="btn-act" onclick="setCasa(true)">CASA</button>
                <button id="btnFuori" class="btn-act" onclick="setCasa(false)">FUORI</button>
            </div>
            <button class="btn-act" style="background:var(--success); margin-top:15px;" onclick="vaiAConvocati()">AVANTI ></button>
        </div>

        <div id="step-convocati" style="display:none;">
            <h3>CONVOCAZIONI</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div id="conv-noi"><h4>NOI</h4><div id="list-noi"></div></div>
                <div id="conv-loro"><h4>LORO</h4><textarea id="list-loro" placeholder="Numeri maglia avversari" style="width:100%; height:100px;"></textarea></div>
            </div>
            <button class="btn-act" style="background:var(--success); margin-top:20px;" onclick="iniziaPartita()">INIZIA PARTITA</button>
        </div>
    </div>

    <div id="gara" style="display: none;">
        <div class="scoreboard">
            <div><div id="nameH">HOME</div><h1 id="scoreH">0</h1><div class="foul-team">F: <span id="fTeamH">0</span> <span id="bonusH" class="bonus">BONUS</span></div></div>
            <div><div id="labelQ">Q1</div><button id="btnQ" class="btn-act" style="background:var(--success);" onclick="gestioneQuarto()">INIZIO Q1</button></div>
            <div><div id="nameA">AWAY</div><h1 id="scoreA">0</h1><div class="foul-team">F: <span id="fTeamA">0</span> <span id="bonusA" class="bonus">BONUS</span></div></div>
        </div>
        <div class="grid-giocatori" id="gridGara"></div>
        <div class="actions-container" id="panelAzioni" style="opacity: 0.3; pointer-events: none;">
             <div class="row-2-1"><button class="btn-act" style="background:var(--warning);" onclick="apriTiro()">üèÄ TIRO</button><button class="btn-act" style="background:#fff; color:#000;" onclick="apriLiberi()">LIBERI</button></div>
             <div class="row-half"><button class="btn-act" style="background:var(--danger);" onclick="regFalloFatto()">üõë FALLO FATTO</button><button class="btn-act" style="background:var(--success);" onclick="apriFalloSubito()">ü§ù FALLO SUBITO</button></div>
             <button class="btn-act" style="background:#fff; color:#000;" onclick="apriCambio()">üîÑ CAMBIO</button>
        </div>
        <div class="footer-nav">
            <button class="btn-nav" onclick="undo()">‚Ü©Ô∏è UNDO</button>
            <button class="btn-nav" onclick="mostraStatistiche()">üìä STATS</button>
        </div>
    </div>

    <div id="modTiro" class="modal"><div class="modal-content"><div id="mappaTiro" onclick="gestisciToccoCampo(event)"><div class="canestro"></div><div class="area-3pt"></div><div class="pitturato"></div></div><div class="row-half" style="margin-top:20px;"><button class="btn-act" style="background:var(--success);" onclick="regEsitoTiro(true)">SI</button><button class="btn-act" style="background:var(--danger);" onclick="regEsitoTiro(false)">NO</button></div><button class="btn-nav" onclick="chiudiModale('modTiro')">CHIUDI</button></div></div>
    <script>
        // CONFIGURAZIONE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAtJVAixoUVY3GMhoza7-UBnHMuKjLZjmE",
            authDomain: "basket-reggello-scout.firebaseapp.com",
            databaseURL: "https://basket-reggello-scout-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "basket-reggello-scout",
            storageBucket: "basket-reggellto-scout.firebasestorage.app",
            messagingSenderId: "395815946220",
            appId: "1:395815946220:web:68c00b4c7f2da1754722c9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let appState = {
            gameId: "", gameRef: null, noiIsCasa: true, durationQ: 10,
            nQ: 1, sH: 0, sA: 0, fH: 0, fA: 0,
            noi: [], loro: [], events: [], inCampo: [], selP: null,
            players: {} 
        };

        function switchSetup(mode) {
            document.getElementById('main-menu').style.display = (mode === 'menu') ? 'block' : 'none';
            document.getElementById('step-nuova').style.display = (mode === 'nuova') ? 'block' : 'none';
            document.getElementById('step-convocati').style.display = (mode === 'convocati') ? 'block' : 'none';
        }

        function vaiAConvocati() {
            appState.gameId = document.getElementById('gameId').value.trim();
            const listNoi = document.getElementById('list-noi');
            listNoi.innerHTML = "";
            for(let i=0; i<12; i++) {
                listNoi.innerHTML += `<input type="number" class="manual-num" placeholder="Num" style="width:45px"> <input type="text" class="manual-name" placeholder="Nome" style="width:100px"><br>`;
            }
            switchSetup('convocati');
        }

        function iniziaPartita() {
            document.querySelectorAll('#list-noi input.manual-num').forEach((el, i) => {
                const num = el.value;
                const name = document.querySelectorAll('#list-noi input.manual-name')[i].value;
                if(num) {
                    appState.noi.push({ num, name });
                    appState.players[num] = { pts:0, f:0, mins:0, lastIn: 600, shots:[] };
                }
            });
            document.getElementById('setup').style.display = 'none';
            document.getElementById('gara').style.display = 'block';
            appState.gameRef = db.ref('games/' + appState.gameId);
            updateUI();
        }

        function updateUI() {
            document.getElementById('scoreH').innerText = appState.sH;
            document.getElementById('scoreA').innerText = appState.sA;
            document.getElementById('fTeamH').innerText = appState.fH;
            document.getElementById('fTeamA').innerText = appState.fA;
            const grid = document.getElementById('gridGara');
            grid.innerHTML = "";
            appState.noi.forEach(p => {
                const d = appState.players[p.num];
                const isField = appState.inCampo.includes(p.num);
                grid.innerHTML += `<button class="btn-giocatore ${isField?'in-campo':''} ${appState.selP==p.num?'selected':''}" onclick="setSel('${p.num}')">
                    <span class="p-name">${p.name}</span><span class="p-num">${p.num}</span><span class="p-pts">${d.pts}</span><span class="p-foul">${d.f}</span>
                </button>`;
            });
        }

        function setSel(n) { appState.selP = (appState.selP === n) ? null : n; updateUI(); }
        function apriModale(id) { document.getElementById(id).style.display = 'flex'; }
        function chiudiModale(id) { document.getElementById(id).style.display = 'none'; }
        
        function gestioneQuarto() {
            document.getElementById('panelAzioni').style.opacity = "1";
            document.getElementById('panelAzioni').style.pointerEvents = "auto";
            appState.inCampo = appState.noi.slice(0,5).map(p => p.num); // Auto-quintetto per test
            updateUI();
        }

        function apriTiro() { if(appState.selP) apriModale('modTiro'); }
        function regEsitoTiro(success) {
            if(success) {
                appState.players[appState.selP].pts += 2;
                if(appState.noiIsCasa) appState.sH += 2; else appState.sA += 2;
            }
            chiudiModale('modTiro');
            updateUI();
            if(appState.gameRef) appState.gameRef.set(appState);
        }
        
        function setCasa(v) { appState.noiIsCasa = v; }
        function undo() { alert("Undo non ancora configurato in questa build rapida."); }
        function mostraStatistiche() { alert("Statistiche calcolate nel database."); }
    </script>
</body>
</html>

