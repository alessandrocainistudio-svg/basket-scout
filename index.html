<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Basket Scout Pro - MultiRoster</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; background: #121212; color: white; touch-action: manipulation; transition: background 0.1s; }
        .flash-green { background: #1e3d24 !important; }
        .flash-red { background: #4d0000 !important; }
        .flash-blue { background: #002b36 !important; }

        .scoreboard { display: grid; grid-template-columns: 1fr 0.8fr 1fr; background: #000; padding: 10px; border-radius: 12px; border: 2px solid #333; margin-bottom: 10px; text-align: center; align-items: center; }
        .score-box h1 { margin: 0; font-size: 42px; color: #ffeb3b; }
        .team-name { font-size: 14px; font-weight: bold; text-transform: uppercase; color: #aaa; }
        .to-container { display: flex; justify-content: center; gap: 3px; margin-top: 5px; }
        .dot { width: 10px; height: 10px; border: 1px solid #555; border-radius: 50%; background: #333; }
        .dot.filled { background: #ff9800; box-shadow: 0 0 5px #ff9800; }

        .grid-giocatori { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .btn-giocatore { padding: 20px 0; background: #2a2a2a; color: white; border: 2px solid #444; border-radius: 12px; font-size: 20px; font-weight: bold; position: relative; }
        .btn-giocatore.in-campo { border-color: #28a745; background: #1e3d24; }
        .btn-giocatore.selected { background: #ff9800 !important; color: black; }
        .pts-badge { position: absolute; top: 4px; left: 8px; color: #7fff7f; font-size: 12px; }
        .foul-badge { position: absolute; bottom: 4px; right: 8px; background: #ff4444; color: white; font-size: 14px; padding: 2px 5px; border-radius: 4px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; align-items: center; overflow-y: auto; padding: 20px 10px; }
        .container-modal { background: #1a1a1a; padding: 20px; border-radius: 15px; width: 100%; max-width: 450px; border: 1px solid #333; text-align: center; margin: auto; }
        
        .roster-item { display: flex; align-items: center; gap: 10px; background: #222; padding: 8px; margin-bottom: 5px; border-radius: 6px; }
        .roster-item input { background: #000; color: white; border: 1px solid #444; padding: 8px; border-radius: 4px; }
        
        .btn-azione { padding: 15px; font-size: 14px; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; }
        .bg-green { background: #28a745; color: white; }
        .bg-red { background: #dc3545; color: white; }
        .bg-yell { background: #ffeb3b; color: black; }
        .full-width { width: 100%; margin-top: 10px; }
        .warning { color: #ff4444; font-size: 12px; margin-top: 5px; display: none; }

        #mappaCampo { width: 310px; height: 240px; background: #d2a679; border: 2px solid white; position: relative; margin: 0 auto; }
        .arco-tre { position: absolute; top: -110px; left: 20px; right: 20px; height: 270px; border: 2px solid white; border-radius: 0 0 160px 160px; }
        .sub-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 10px 0; }
        .btn-sub { padding: 10px 0; background: #333; color: white; border: 1px solid #555; border-radius: 5px; }
        .active-in { background: #28a745 !important; }
        .active-out { background: #dc3545 !important; }
        .separatore { border-top: 1px solid #444; margin: 15px 0; padding-top: 10px; }
    </style>
</head>
<body onload="apriModal('modalCloud')">

    <div class="scoreboard">
        <div class="score-box">
            <h1 id="scoreHome">0</h1>
            <div class="team-name" id="nameH">CASA</div>
            <div id="dotsHome" class="to-container"></div>
            <button onclick="addTO('Home')" style="font-size:9px; margin-top:5px;">TIMEOUT</button>
        </div>
        <div>
            <div id="labelQuarto" style="color:#ff9800; font-weight:bold;">Q1</div>
            <div id="syncStatus" style="font-size:9px; color:#7fff7f;">DISCONNESSO</div>
            <button id="btnStato" onclick="toggleQuarto()" style="background:#28a745; color:white; border:none; padding:8px; border-radius:5px; margin-top:5px; font-size:12px;">INIZIA</button>
        </div>
        <div class="score-box">
            <h1 id="scoreAway">0</h1>
            <div class="team-name" id="nameA">TRASFERTA</div>
            <div id="dotsAway" class="to-container"></div>
            <button onclick="addTO('Away')" style="font-size:9px; margin-top:5px;">TIMEOUT</button>
        </div>
    </div>

    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
        <button style="flex:1; background:#331a1a; color:#ff7f7f; border:1px solid #663333; border-radius:5px; padding:10px;" onclick="addOppPoint(1)">+1</button>
        <button style="flex:1; background:#331a1a; color:#ff7f7f; border:1px solid #663333; border-radius:5px; padding:10px;" onclick="addOppPoint(2)">+2</button>
        <button style="flex:1; background:#331a1a; color:#ff7f7f; border:1px solid #663333; border-radius:5px; padding:10px;" onclick="addOppPoint(3)">+3</button>
        <button style="flex:1; background:#4d0000; color:white; border:none; border-radius:5px;" onclick="apriModal('modalFalloAvversario')">FALLO AVV</button>
    </div>

    <div class="grid-giocatori" id="rosterGara"></div>

    <div class="grid-giocatori" id="azioni" style="display:none; grid-template-columns: 1fr 1fr;">
        <button class="btn-azione bg-yell" style="grid-column: span 2;" onclick="if(selP) apriModal('modalCampo')">üèÄ TIRO</button>
        <button class="btn-azione bg-red" onclick="registraFalloFatto()">üõë FALLO FATTO</button>
        <button class="btn-azione bg-green" onclick="if(selP) apriModal('modalFalloSubito')">ü§ù FALLO SUBITO</button>
        <button class="btn-azione" style="background:#add8e6" onclick="logQuick('Rimbalzo Dif', 'blue')">‚¨áÔ∏è R. DIF</button>
        <button class="btn-azione" style="background:#add8e6" onclick="logQuick('Rimbalzo Off', 'blue')">‚¨ÜÔ∏è R. OFF</button>
        <button class="btn-azione" style="background:#ffa07a" onclick="logQuick('Palla Persa', 'red')">‚ö†Ô∏è PERSA</button>
        <button class="btn-azione" style="background:#98fb98" onclick="logQuick('Palla Recuperata', 'green')">üõ°Ô∏è RECUPERO</button>
        <button class="btn-azione bg-white" style="grid-column: span 2;" onclick="apriModalCambio()">üîÑ CAMBIO</button>
    </div>

    <div id="modalCloud" class="modal">
        <div class="container-modal">
            <h2>BASKET SCOUT üèÄ</h2>
            <input type="text" id="gameId" style="width:90%; padding:15px; margin-bottom:15px; border-radius:8px;" placeholder="Nome Partita">
            
            <div class="separatore"></div>
            <h3>SQUADRA</h3>
            <select id="selectSquadra" style="width:100%; padding:12px; background:#222; color:white; border-radius:8px; margin-bottom:10px;"></select>
            
            <button class="btn-azione bg-green full-width" onclick="preparaConvocati()">SELEZIONA SQUADRA</button>
            <button class="btn-azione bg-yell full-width" onclick="apriGestioneRoster()">CREA / MODIFICA ROSTER</button>
        </div>
    </div>

    <div id="modalGestioneRoster" class="modal">
        <div class="container-modal">
            <h3>GESTIONE SQUADRE</h3>
            <input type="text" id="nuovoNomeSquadra" placeholder="Nome Squadra (es: Under 17)" style="width:90%; padding:12px; margin-bottom:10px;">
            <div id="editorGiocatori" style="max-height: 250px; overflow-y: auto;"></div>
            <button class="btn-azione bg-yell full-width" onclick="aggiungiRigaGiocatore()">+ GIOCATORE</button>
            <div class="separatore"></div>
            <button class="btn-azione bg-green full-width" onclick="salvaNuovoRoster()">SALVA SQUADRA</button>
            <button class="btn-azione bg-red full-width" id="btnEliminaSquadra" style="display:none;" onclick="eliminaSquadra()">ELIMINA SQUADRA</button>
            <button class="btn-azione full-width" onclick="chiudiModal('modalGestioneRoster'); apriModal('modalCloud')">ANNULLA</button>
        </div>
    </div>

    <div id="modalConvocati" class="modal">
        <div class="container-modal">
            <h3 id="titoloConvocati">CONVOCATI</h3>
            <div id="listaConvocati"></div>
            <div id="warnConvocati" class="warning">ATTENZIONE: Numeri maglia duplicati!</div>
            <button class="btn-azione bg-green full-width" id="btnSalvaConvocati" onclick="vaiAConfig()">AVANTI</button>
        </div>
    </div>

    <div id="modalConfig" class="modal">
        <div class="container-modal">
            <h3>CONFIGURAZIONE GARA</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button id="cHome" class="btn-azione" style="flex:1; background:#444;" onclick="setNoi('Home')">CASA</button>
                <button id="cAway" class="btn-azione" style="flex:1; background:#444;" onclick="setNoi('Away')">FUORI</button>
            </div>
            <input type="text" id="oppName" placeholder="Nome Avversari" style="width:90%; padding:12px; margin-bottom:10px;">
            <p>Numeri Avversari (es: 4 7 10)</p>
            <input type="text" id="oppNumbers" placeholder="4 8 11 23" style="width:90%; padding:12px;">
            <button class="btn-azione bg-green full-width" style="margin-top:20px;" onclick="avviaGara()">INIZIA SCOUTING</button>
        </div>
    </div>

    <div id="modalFineQuarto" class="modal"><div class="container-modal"><h3 id="titoloFineQ">FINE</h3><button class="btn-azione bg-green full-width" onclick="azioneProssimoQuarto()">PROSSIMO Q</button><button class="btn-azione bg-red full-width" onclick="azioneTerminaPartita()">TERMINA</button><button class="btn-azione full-width" onclick="chiudiModal('modalFineQuarto')">ANNULLA</button></div></div>
    <div id="modalTitolari" class="modal"><div class="container-modal"><h3>5 TITOLARI</h3><div class="grid-giocatori" id="titolariGrid"></div><button id="confirmTitolari" disabled onclick="confermaTitolari()" class="btn-azione bg-green full-width">CONFERMA</button></div></div>
    <div id="modalCambio" class="modal"><div class="container-modal"><h3>üîÑ CAMBIO</h3><input type="tel" id="minutoCambio" maxlength="3" placeholder="MSS" style="font-size:24px; width:100px; text-align:center;"><div id="outG" class="sub-grid"></div><div class="separatore"></div><div id="inG" class="sub-grid"></div><button id="confCambio" disabled onclick="eseguiCambio()" class="btn-azione bg-green full-width">CONFERMA</button></div></div>
    <div id="modalFalloAvversario" class="modal"><div class="container-modal"><h3>FALLO AVV</h3><div id="oppFoulGrid" class="sub-grid"></div><button class="btn-azione full-width" onclick="chiudiModal('modalFalloAvversario')">CHIUDI</button></div></div>
    <div id="modalCampo" class="modal"><div class="container-modal"><h3>TIRO</h3><div id="mappaCampo" onclick="segnaPunto(event)"><div class="arco-tre"></div></div><div style="display:flex; gap:10px; margin-top:10px;"><button class="bg-green" style="flex:1; padding:20px" onclick="regTiro('SEGNATO')">SI</button><button class="bg-red" style="flex:1; padding:20px" onclick="regTiro('SBAGLIATO')">NO</button></div></div></div>
    <div id="modalFalloSubito" class="modal"><div class="container-modal"><h3>FALLO SUBITO</h3><div id="oppFoulPerNoi" class="sub-grid"></div><button class="btn-azione bg-yell full-width" onclick="chiudiModal('modalFalloSubito'); apriModal('modalLibero')">LIBERI</button></div></div>
    <div id="modalLibero" class="modal"><div class="container-modal"><h3>LIBERI</h3><div id="lib-seq"></div><button class="bg-green" onclick="regLib('SEGNATO')">OK</button><button class="bg-red" onclick="regLib('X')">X</button><button onclick="chiudiModal('modalLibero')">FINE</button></div></div>

    <script>
        // --- LOGICA DATABASE ROSTER ---
        let databaseSquadre = JSON.parse(localStorage.getItem('databaseSquadre')) || {};
        let currentSquadraEdit = null;

        function aggiornaSelectSquadre() {
            const sel = document.getElementById('selectSquadra');
            sel.innerHTML = '<option value="">-- Seleziona Squadra --</option>';
            Object.keys(databaseSquadre).forEach(s => {
                sel.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }
        aggiornaSelectSquadre();

        function apriGestioneRoster() {
            const nomeSel = document.getElementById('selectSquadra').value;
            currentSquadraEdit = nomeSel || null;
            document.getElementById('nuovoNomeSquadra').value = currentSquadraEdit || "";
            document.getElementById('editorGiocatori').innerHTML = "";
            document.getElementById('btnEliminaSquadra').style.display = currentSquadraEdit ? 'block' : 'none';
            
            if(currentSquadraEdit) {
                databaseSquadre[currentSquadraEdit].forEach(p => aggiungiRigaGiocatore(p.n, p.nome));
            } else {
                for(let i=0; i<5; i++) aggiungiRigaGiocatore();
            }
            chiudiModal('modalCloud');
            apriModal('modalGestioneRoster');
        }

        function aggiungiRigaGiocatore(n="", nome="") {
            const div = document.createElement('div');
            div.className = "roster-item";
            div.innerHTML = `
                <input type="number" class="edit-num" value="${n}" placeholder="#" style="width:45px">
                <input type="text" class="edit-nome" value="${nome}" placeholder="Nome" style="flex:1">
                <button class="bg-red" style="border:none; padding:5px 10px; border-radius:4px" onclick="this.parentElement.remove()">X</button>
            `;
            document.getElementById('editorGiocatori').appendChild(div);
        }

        function salvaNuovoRoster() {
            const nome = document.getElementById('nuovoNomeSquadra').value.trim();
            if(!nome) return alert("Inserisci il nome della squadra");

            const righe = document.querySelectorAll('.roster-item');
            const lista = [];
            const numeriSet = new Set();
            let erroreDuplicati = false;

            righe.forEach(r => {
                const num = r.querySelector('.edit-num').value;
                const nme = r.querySelector('.edit-nome').value;
                if(num) {
                    if(numeriSet.has(num)) erroreDuplicati = true;
                    numeriSet.add(num);
                    lista.push({n: num, nome: nme});
                }
            });

            if(erroreDuplicati) return alert("Errore: ci sono numeri maglia duplicati!");

            databaseSquadre[nome] = lista;
            localStorage.setItem('databaseSquadre', JSON.stringify(databaseSquadre));
            aggiornaSelectSquadre();
            chiudiModal('modalGestioneRoster');
            apriModal('modalCloud');
        }

        function eliminaSquadra() {
            if(confirm("Eliminare definitivamente questa squadra?")) {
                delete databaseSquadre[currentSquadraEdit];
                localStorage.setItem('databaseSquadre', JSON.stringify(databaseSquadre));
                aggiornaSelectSquadre();
                chiudiModal('modalGestioneRoster');
                apriModal('modalCloud');
            }
        }

        // --- GESTIONE PARTITA ---
        let convocati = [], avversariNums = [], falliAvv = {};
        let nQ = 1, sH = 0, sA = 0, fH = 0, fA = 0, toH = 0, toA = 0;
        let inC = [], stats = [], selP = null, noiIsCasa = true, pF = {}, pP = {}, gameRef = null;

        const firebaseConfig = {
            apiKey: "AIzaSyAtJVAixoUVY3GMhoza7-UBnHMuKjLZjmE",
            authDomain: "basket-reggello-scout.firebaseapp.com",
            databaseURL: "https://basket-reggello-scout-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "basket-reggello-scout",
            storageBucket: "basket-reggello-scout.firebasestorage.app",
            messagingSenderId: "395815946220",
            appId: "1:395815946220:web:68c00b4c7f2da1754722c9",
            measurementId: "G-8DFL77TB65"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function preparaConvocati() {
            const sq = document.getElementById('selectSquadra').value;
            if(!sq) return alert("Seleziona una squadra!");
            
            const cont = document.getElementById('listaConvocati');
            cont.innerHTML = "";
            databaseSquadre[sq].forEach((p, i) => {
                cont.innerHTML += `
                    <div class="roster-item">
                        <input type="checkbox" checked class="conv-check" style="width:20px;height:20px">
                        <input type="number" value="${p.n}" class="conv-num" style="width:45px" oninput="validaConvocati()">
                        <span style="flex:1;text-align:left">${p.nome}</span>
                    </div>`;
            });
            chiudiModal('modalCloud');
            apriModal('modalConvocati');
            validaConvocati();
        }

        function validaConvocati() {
            const inputs = document.querySelectorAll('.conv-num');
            const nums = [];
            let dupe = false;
            inputs.forEach(i => {
                if(nums.includes(i.value)) dupe = true;
                nums.push(i.value);
            });
            document.getElementById('warnConvocati').style.display = dupe ? 'block' : 'none';
            document.getElementById('btnSalvaConvocati').disabled = dupe;
        }

        function vaiAConfig() {
            convocati = [];
            const items = document.querySelectorAll('#listaConvocati .roster-item');
            items.forEach(item => {
                if(item.querySelector('.conv-check').checked) {
                    const n = item.querySelector('.conv-num').value;
                    const nm = item.querySelector('span').innerText;
                    convocati.push({n, nome: nm});
                    pF[n] = 0; pP[n] = 0;
                }
            });
            chiudiModal('modalConvocati');
            apriModal('modalConfig');
        }

        function avviaGara() {
            const id = document.getElementById('gameId').value.trim();
            if(!id) return alert("Inserisci nome partita!");
            gameRef = db.ref('games/' + id);

            const oName = document.getElementById('oppName').value || "AVVERSARI";
            avversariNums = document.getElementById('oppNumbers').value.split(/[\s,]+/).filter(n => n !== "");
            avversariNums.forEach(n => falliAvv[n] = 0);

            const myTeamName = document.getElementById('selectSquadra').value;
            if(noiIsCasa) {
                document.getElementById('nameH').innerText = myTeamName;
                document.getElementById('nameA').innerText = oName;
            } else {
                document.getElementById('nameH').innerText = oName;
                document.getElementById('nameA').innerText = myTeamName;
            }

            const gridgara = document.getElementById('rosterGara');
            gridgara.innerHTML = "";
            convocati.forEach(p => {
                gridgara.innerHTML += `<button class="btn-giocatore" id="p${p.n}" onclick="selezionaGiocatore('${p.n}')">
                    <span class="pts-badge" id="pts${p.n}">0</span>${p.n}<span class="foul-badge" id="foul${p.n}">0</span></button>`;
            });

            chiudiModal('modalConfig');
            document.getElementById('syncStatus').innerText = "LIVE: " + id;
            updateUI(); cloudSave();
        }

        // --- SISTEMA DI GIOCO ---
        function setNoi(p) { noiIsCasa=(p==='Home'); document.getElementById('cHome').style.background=noiIsCasa?'#28a745':'#444'; document.getElementById('cAway').style.background=!noiIsCasa?'#28a745':'#444'; }
        function doFlash(t){ document.body.classList.add('flash-'+t); setTimeout(()=>document.body.classList.remove('flash-'+t),150); }
        function toggleQuarto(){ if(document.getElementById('btnStato').innerText.includes("INIZIA")){ fH=0; fA=0; apriModalTitolari(); } else { apriModal('modalFineQuarto'); } }
        function azioneProssimoQuarto(){ chiudiModal('modalFineQuarto'); if(nQ===2 || nQ>=4){ toH=0; toA=0; } nQ++; document.getElementById('azioni').style.display='none'; document.getElementById('btnStato').innerText="INIZIA Q"+nQ; updateUI(); cloudSave(); }
        function apriModalTitolari(){ const g=document.getElementById('titolariGrid'); g.innerHTML=""; convocati.forEach(p=>{ g.innerHTML+=`<button class="btn-sub" onclick="this.classList.toggle('active-in');checkTit()">${p.n}</button>`; }); apriModal('modalTitolari'); }
        function checkTit(){ const c=document.querySelectorAll('#titolariGrid .active-in').length; document.getElementById('confirmTitolari').disabled=(c!==5); }
        function confermaTitolari(){ inC=Array.from(document.querySelectorAll('.active-in')).map(b=>b.innerText); chiudiModal('modalTitolari'); document.getElementById('azioni').style.display='grid'; document.getElementById('btnStato').innerText="FINE Q"+nQ; updateUI(); cloudSave(); }
        function selezionaGiocatore(n){ if(inC.includes(n)){ selP=(selP===n)?null:n; updateUI(); } }
        function registraFalloFatto(){ if(!selP) return; doFlash('red'); pF[selP]++; if(noiIsCasa) fH++; else fA++; salva("Fallo", selP, pF[selP]+"¬∞"); updateUI(); if(pF[selP]>=5) apriModalCambio(selP); cloudSave(); }
        function registraFalloAvversario(n){ falliAvv[n]++; if(noiIsCasa) fA++; else fH++; salva("Fallo Avv", n, falliAvv[n]+"¬∞"); chiudiModal('modalFalloAvversario'); chiudiModal('modalFalloSubito'); updateUI(); cloudSave(); }
        function addOppPoint(v){ doFlash('red'); if(noiIsCasa) sA+=v; else sH+=v; salva("Punti Avv", "Osp", "+"+v); updateUI(); cloudSave(); }
        function logQuick(a,f){ if(selP){ doFlash(f); salva(a, selP, "-"); updateUI(); cloudSave(); } }
        function cloudSave(){ if(gameRef) gameRef.set({nQ, sH, sA, fH, fA, toH, toA, inC, stats, pF, pP, falliAvv}); }
        function updateUI(){
            document.getElementById('scoreHome').innerText=sH; document.getElementById('scoreAway').innerText=sA;
            document.getElementById('labelQuarto').innerText=nQ>4?"OT":"Q"+nQ;
            convocati.forEach(p=>{ const b=document.getElementById('p'+p.n); if(b){ document.getElementById('pts'+p.n).innerText=pP[p.n]; document.getElementById('foul'+p.n).innerText=pF[p.n]; b.className="btn-giocatore "+(inC.includes(p.n)?"in-campo ":"")+(selP==p.n?"selected":""); }});
            renderDots('dotsHome', toH); renderDots('dotsAway', toA);
            const fg=document.getElementById('oppFoulGrid'); const fn=document.getElementById('oppFoulPerNoi');
            fg.innerHTML=""; fn.innerHTML=""; avversariNums.forEach(n=>{
                fg.innerHTML+=`<button class="btn-sub" onclick="registraFalloAvversario('${n}')">${n} (${falliAvv[n]})</button>`;
                fn.innerHTML+=`<button class="btn-sub" onclick="registraFalloAvversario('${n}')">${n}</button>`;
            });
        }
        function renderDots(id,u){ const c=document.getElementById(id); c.innerHTML=""; let l=(nQ<=2)?2:(nQ<=4?3:1); for(let i=0; i<l; i++) c.innerHTML+=`<div class="dot ${i<u?'filled':''}"></div>`; }
        function apriModal(id){ document.getElementById(id).style.display='flex'; }
        function chiudiModal(id){ document.getElementById(id).style.display='none'; }
        function salva(a,g,e){ stats.push({Q:nQ, G:g, Azione:a, Esito:e}); }
        function addTO(t){ if(t==='Home') toH++; else toA++; updateUI(); cloudSave(); }
    </script>
</body>
</html>
