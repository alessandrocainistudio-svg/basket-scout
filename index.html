<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Basket Scout Pro - Roster Manager</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; background: #121212; color: white; touch-action: manipulation; transition: background 0.1s; }
        .flash-green { background: #1e3d24 !important; }
        .flash-red { background: #4d0000 !important; }
        .flash-blue { background: #002b36 !important; }

        /* UI Base */
        .scoreboard { display: grid; grid-template-columns: 1fr 0.8fr 1fr; background: #000; padding: 10px; border-radius: 12px; border: 2px solid #333; margin-bottom: 10px; text-align: center; align-items: center; }
        .score-box h1 { margin: 0; font-size: 42px; color: #ffeb3b; }
        .team-name { font-size: 14px; font-weight: bold; text-transform: uppercase; color: #aaa; overflow: hidden; text-overflow: ellipsis; }
        .to-container { display: flex; justify-content: center; gap: 3px; margin-top: 5px; }
        .dot { width: 10px; height: 10px; border: 1px solid #555; border-radius: 50%; background: #333; }
        .dot.filled { background: #ff9800; box-shadow: 0 0 5px #ff9800; }

        /* Liste e Grid */
        .grid-giocatori { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .btn-giocatore { padding: 20px 0; background: #2a2a2a; color: white; border: 2px solid #444; border-radius: 12px; font-size: 20px; font-weight: bold; position: relative; }
        .btn-giocatore.in-campo { border-color: #28a745; background: #1e3d24; }
        .btn-giocatore.selected { background: #ff9800 !important; color: black; }
        .pts-badge { position: absolute; top: 4px; left: 8px; color: #7fff7f; font-size: 12px; }
        .foul-badge { position: absolute; bottom: 4px; right: 8px; background: #ff4444; color: white; font-size: 14px; padding: 2px 5px; border-radius: 4px; }

        /* Modali */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; align-items: center; overflow-y: auto; padding: 20px 10px; }
        .container-modal { background: #1a1a1a; padding: 20px; border-radius: 15px; width: 100%; max-width: 450px; border: 1px solid #333; text-align: center; margin: auto; }
        
        /* Setup Roster */
        .roster-item { display: flex; align-items: center; gap: 10px; background: #222; padding: 8px; margin-bottom: 5px; border-radius: 6px; }
        .roster-item input { background: #000; color: white; border: 1px solid #444; padding: 8px; border-radius: 4px; }
        .convocato-check { width: 25px; height: 25px; }

        .btn-azione { padding: 15px; font-size: 14px; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; }
        .bg-green { background: #28a745; color: white; }
        .bg-red { background: #dc3545; color: white; }
        .bg-yell { background: #ffeb3b; color: black; }
        .full-width { width: 100%; margin-top: 10px; }

        #mappaCampo { width: 310px; height: 240px; background: #d2a679; border: 2px solid white; position: relative; margin: 0 auto; }
        .arco-tre { position: absolute; top: -110px; left: 20px; right: 20px; height: 270px; border: 2px solid white; border-radius: 0 0 160px 160px; }
        .sub-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 10px 0; }
        .btn-sub { padding: 10px 0; background: #333; color: white; border: 1px solid #555; border-radius: 5px; }
        .active-in { background: #28a745 !important; }
        .active-out { background: #dc3545 !important; }
        .separatore { border-top: 1px solid #444; margin: 15px 0; padding-top: 10px; }
    </style>
</head>
<body onload="apriModal('modalCloud')">

    <div class="scoreboard">
        <div class="score-box">
            <h1 id="scoreHome">0</h1>
            <div class="team-name" id="nameH">CASA</div>
            <div id="dotsHome" class="to-container"></div>
            <button onclick="addTO('Home')" style="font-size:9px; margin-top:5px;">TIMEOUT</button>
        </div>
        <div>
            <div id="labelQuarto" style="color:#ff9800; font-weight:bold;">Q1</div>
            <div id="syncStatus" style="font-size:9px; color:#7fff7f;">DISCONNESSO</div>
            <button id="btnStato" onclick="toggleQuarto()" style="background:#28a745; color:white; border:none; padding:8px; border-radius:5px; margin-top:5px; font-size:12px;">INIZIA</button>
        </div>
        <div class="score-box">
            <h1 id="scoreAway">0</h1>
            <div class="team-name" id="nameA">TRASFERTA</div>
            <div id="dotsAway" class="to-container"></div>
            <button onclick="addTO('Away')" style="font-size:9px; margin-top:5px;">TIMEOUT</button>
        </div>
    </div>

    <div style="display: flex; gap: 5px; margin-bottom: 10px;">
        <div style="font-size:10px; writing-mode: vertical-lr; text-align:center; background:#331a1a; color:#ff7f7f; padding:2px;">AVV</div>
        <button style="flex:1; background:#331a1a; color:#ff7f7f; border:1px solid #663333; border-radius:5px; padding:10px;" onclick="addOppPoint(1)">+1</button>
        <button style="flex:1; background:#331a1a; color:#ff7f7f; border:1px solid #663333; border-radius:5px; padding:10px;" onclick="addOppPoint(2)">+2</button>
        <button style="flex:1; background:#331a1a; color:#ff7f7f; border:1px solid #663333; border-radius:5px; padding:10px;" onclick="addOppPoint(3)">+3</button>
        <button style="flex:1; background:#4d0000; color:white; border:none; border-radius:5px;" onclick="apriModal('modalFalloAvversario')">FALLO AVV</button>
    </div>

    <div class="grid-giocatori" id="rosterGara"></div>

    <div class="grid-giocatori" id="azioni" style="display:none; grid-template-columns: 1fr 1fr;">
        <button class="btn-azione bg-yell" style="grid-column: span 2;" onclick="if(selP) apriModal('modalCampo')">üèÄ TIRO</button>
        <button class="btn-azione bg-red" onclick="registraFalloFatto()">üõë FALLO FATTO</button>
        <button class="btn-azione bg-green" onclick="if(selP) apriModal('modalFalloSubito')">ü§ù FALLO SUBITO</button>
        <button class="btn-azione" style="background:#add8e6" onclick="logQuick('Rimbalzo Dif', 'blue')">‚¨áÔ∏è R. DIF</button>
        <button class="btn-azione" style="background:#add8e6" onclick="logQuick('Rimbalzo Off', 'blue')">‚¨ÜÔ∏è R. OFF</button>
        <button class="btn-azione" style="background:#ffa07a" onclick="logQuick('Palla Persa', 'red')">‚ö†Ô∏è PERSA</button>
        <button class="btn-azione" style="background:#98fb98" onclick="logQuick('Palla Recuperata', 'green')">üõ°Ô∏è RECUPERO</button>
        <button class="btn-azione bg-white" style="grid-column: span 2;" onclick="apriModalCambio()">üîÑ CAMBIO</button>
    </div>

    <div id="modalCloud" class="modal">
        <div class="container-modal">
            <h2>BASKET SCOUT üèÄ</h2>
            <input type="text" id="gameId" style="width:90%; padding:15px; margin-bottom:15px; border-radius:8px;" placeholder="Nome della Partita (es: U17_Gara1)">
            <button class="btn-azione bg-green full-width" onclick="connettiCloud()">AVVIA PARTITA</button>
            <div class="separatore"></div>
            <h3>GESTIONE ROSTER BASE</h3>
            <p style="font-size:11px; color:#888;">Inserisci qui i tuoi giocatori abituali</p>
            <div id="listaRosterBase" style="max-height: 200px; overflow-y: auto; margin-bottom:10px;"></div>
            <button class="btn-azione bg-yell full-width" onclick="aggiungiGiocatoreBase()">+ AGGIUNGI GIOCATORE</button>
        </div>
    </div>

    <div id="modalConvocati" class="modal">
        <div class="container-modal">
            <h3>CHI GIOCA OGGI?</h3>
            <p style="font-size:11px; color:#888;">Seleziona i convocati e modifica il numero se necessario</p>
            <div id="listaConvocati"></div>
            <button class="btn-azione bg-green full-width" onclick="salvaConvocati()">CONFERMA CONVOCATI</button>
        </div>
    </div>

    <div id="modalConfig" class="modal">
        <div class="container-modal">
            <h3>DETTAGLI GARA</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button id="cHome" class="btn-azione" style="flex:1; background:#444;" onclick="setNoi('Home')">NOI IN CASA</button>
                <button id="cAway" class="btn-azione" style="flex:1; background:#444;" onclick="setNoi('Away')">NOI FUORI</button>
            </div>
            <input type="text" id="oppName" placeholder="Nome Squadra Avversaria" style="width:90%; padding:12px; margin-bottom:10px;">
            <div class="separatore"></div>
            <p>Numeri Maglia Avversari (separati da spazio o virgola)</p>
            <input type="text" id="oppNumbers" placeholder="es: 4 7 10 12 23" style="width:90%; padding:12px;">
            <button class="btn-azione bg-green full-width" style="margin-top:20px;" onclick="avviaGara()">INIZIA SCOUTING</button>
        </div>
    </div>

    <div id="modalFineQuarto" class="modal">
        <div class="container-modal">
            <h3 id="titoloFineQ">FINE PERIODO</h3>
            <button class="btn-azione bg-green full-width" onclick="azioneProssimoQuarto()">PROSSIMO QUARTO</button>
            <button class="btn-azione bg-red full-width" onclick="azioneTerminaPartita()">TERMINA PARTITA</button>
            <button class="btn-azione full-width" onclick="chiudiModal('modalFineQuarto')">ANNULLA</button>
        </div>
    </div>

    <div id="modalTitolari" class="modal"><div class="container-modal"><h3 id="titTitolari">5 TITOLARI</h3><div class="grid-giocatori" id="titolariGrid"></div><button id="confirmTitolari" disabled onclick="confermaTitolari()" class="btn-azione bg-green full-width">CONFERMA (0/5)</button></div></div>

    <div id="modalCambio" class="modal">
        <div class="container-modal">
            <h3>üîÑ CAMBIO</h3>
            <input type="tel" id="minutoCambio" maxlength="3" placeholder="Minuto (MSS)" style="font-size:24px; width:100px; text-align:center; margin-bottom:10px;" oninput="checkC()">
            <p style="font-size:10px;">CHI ESCE</p><div id="outG" class="sub-grid"></div>
            <div class="separatore"></div>
            <p style="font-size:10px;">CHI ENTRA</p><div id="inG" class="sub-grid"></div>
            <button id="confCambio" disabled onclick="eseguiCambio()" class="btn-azione bg-green full-width">CONFERMA</button>
            <button class="btn-azione full-width" onclick="chiudiModal('modalCambio')">CHIUDI</button>
        </div>
    </div>

    <div id="modalFalloAvversario" class="modal">
        <div class="container-modal">
            <h3>FALLO AVVERSARIO</h3>
            <div id="oppFoulGrid" class="sub-grid"></div>
            <button class="btn-azione full-width" onclick="chiudiModal('modalFalloAvversario')">ANNULLA</button>
        </div>
    </div>

    <div id="modalCampo" class="modal"><div class="container-modal"><h3 id="infoTiro">Tiro</h3><div id="mappaCampo" onclick="segnaPunto(event)"><div class="arco-tre"></div></div><div style="display:flex; gap:10px; margin-top:10px;"><button style="flex:1; padding:20px;" class="bg-green" onclick="regTiro('SEGNATO')">SI</button><button style="flex:1; padding:20px;" class="bg-red" onclick="regTiro('SBAGLIATO')">NO</button></div><button class="btn-azione full-width" onclick="chiudiModal('modalCampo')">ANNULLA</button></div></div>
    
    <div id="modalFalloSubito" class="modal"><div class="container-modal"><h3>FALLO SUBITO</h3><p>Chi ha commesso il fallo?</p><div id="oppFoulPerNoi" class="sub-grid" style="margin-bottom:15px;"></div><button class="btn-azione bg-yell full-width" onclick="concludiFalloSubito(true)">VAI AI LIBERI</button><button class="btn-azione full-width" onclick="chiudiModal('modalFalloSubito')">ANNULLA</button></div></div>

    <script>
        // --- LOGICA ROSTER E INIZIALIZZAZIONE ---
        let rosterBase = JSON.parse(localStorage.getItem('rosterBase')) || [
            {n: "4", nome: "Giocatore 1"}, {n: "7", nome: "Giocatore 2"}, {n: "10", nome: "Giocatore 3"}
        ];
        let convocati = [];
        let avversariNums = [];
        let falliAvv = {};

        function aggiungiGiocatoreBase() {
            rosterBase.push({n: "", nome: ""});
            renderRosterBase();
        }

        function renderRosterBase() {
            const cont = document.getElementById('listaRosterBase');
            cont.innerHTML = "";
            rosterBase.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = "roster-item";
                div.innerHTML = `
                    <input type="number" value="${p.n}" placeholder="#" style="width:40px" onchange="rosterBase[${i}].n=this.value; saveBase()">
                    <input type="text" value="${p.nome}" placeholder="Nome" style="flex:1" onchange="rosterBase[${i}].nome=this.value; saveBase()">
                    <button class="bg-red" style="padding:5px 10px; border-radius:4px; border:none;" onclick="rosterBase.splice(${i},1); saveBase(); renderRosterBase()">X</button>
                `;
                cont.appendChild(div);
            });
        }
        function saveBase() { localStorage.setItem('rosterBase', JSON.stringify(rosterBase)); }
        renderRosterBase();

        // --- GESTIONE FIREBASE & GARA ---
        const firebaseConfig = {
            apiKey: "AIzaSyAtJVAixoUVY3GMhoza7-UBnHMuKjLZjmE",
            authDomain: "basket-reggello-scout.firebaseapp.com",
            databaseURL: "https://basket-reggello-scout-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "basket-reggello-scout",
            storageBucket: "basket-reggello-scout.firebasestorage.app",
            messagingSenderId: "395815946220",
            appId: "1:395815946220:web:68c00b4c7f2da1754722c9",
            measurementId: "G-8DFL77TB65"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let gameRef = null;

        let nQ = 1, sH = 0, sA = 0, fH = 0, fA = 0, toH = 0, toA = 0;
        let inC = [], stats = [], selP = null, noiIsCasa = true;
        let pF = {}, pP = {}, oppName = "";

        function connettiCloud() {
            const id = document.getElementById('gameId').value.trim();
            if(!id) return;
            gameRef = db.ref('games/' + id);
            
            // Passiamo alla selezione convocati
            apriModal('modalConvocati');
            const cont = document.getElementById('listaConvocati');
            cont.innerHTML = "";
            rosterBase.forEach((p, i) => {
                if(!p.n) return;
                const div = document.createElement('div');
                div.className = "roster-item";
                div.innerHTML = `
                    <input type="checkbox" class="convocato-check" checked data-idx="${i}">
                    <input type="number" value="${p.n}" style="width:40px" id="numConv_${i}">
                    <span style="flex:1; text-align:left; margin-left:10px;">${p.nome}</span>
                `;
                cont.appendChild(div);
            });
        }

        function salvaConvocati() {
            convocati = [];
            const checks = document.querySelectorAll('.convocato-check');
            checks.forEach(c => {
                if(c.checked) {
                    const idx = c.getAttribute('data-idx');
                    const n = document.getElementById(`numConv_${idx}`).value;
                    convocati.push({ n: n, nome: rosterBase[idx].nome });
                    pF[n] = 0; pP[n] = 0;
                }
            });
            chiudiModal('modalConvocati');
            apriModal('modalConfig');
        }

        function setNoi(pos) {
            noiIsCasa = (pos === 'Home');
            document.getElementById('cHome').style.background = noiIsCasa ? '#28a745' : '#444';
            document.getElementById('cAway').style.background = !noiIsCasa ? '#28a745' : '#444';
        }

        function avviaGara() {
            oppName = document.getElementById('oppName').value || "AVVERSARI";
            const numsStr = document.getElementById('oppNumbers').value;
            avversariNums = numsStr.split(/[\s,]+/).filter(n => n !== "");
            
            // Setup nomi squadra
            if(noiIsCasa) {
                document.getElementById('nameH').innerText = "NOI";
                document.getElementById('nameA').innerText = oppName;
            } else {
                document.getElementById('nameH').innerText = oppName;
                document.getElementById('nameA').innerText = "NOI";
            }

            // Inizializza falli avversari
            avversariNums.forEach(n => falliAvv[n] = 0);
            
            // Renderizza pulsanti nostra squadra
            const gridgara = document.getElementById('rosterGara');
            gridgara.innerHTML = "";
            convocati.forEach(p => {
                gridgara.innerHTML += `<button class="btn-giocatore" id="p${p.n}" onclick="selezionaGiocatore('${p.n}')">
                    <span class="pts-badge" id="pts${p.n}">0</span>
                    ${p.n}
                    <span class="foul-badge" id="foul${p.n}">0</span>
                </button>`;
            });

            chiudiModal('modalConfig');
            updateUI();
            cloudSave();
        }

        // --- FUNZIONI DI GIOCO (Corrette come richiesto) ---
        function doFlash(type) {
            const cls = "flash-" + type;
            document.body.classList.add(cls);
            setTimeout(() => document.body.classList.remove(cls), 150);
        }

        function toggleQuarto() {
            if (document.getElementById('btnStato').innerText.includes("INIZIA")) {
                fH = 0; fA = 0; apriModalTitolari();
            } else {
                document.getElementById('titoloFineQ').innerText = "FINE Q" + nQ;
                apriModal('modalFineQuarto');
            }
        }

        function azioneProssimoQuarto() {
            chiudiModal('modalFineQuarto');
            if(nQ === 2 || nQ >= 4) { toH = 0; toA = 0; }
            nQ++;
            document.getElementById('azioni').style.display = 'none';
            document.getElementById('btnStato').innerText = "INIZIA Q" + nQ;
            document.getElementById('btnStato').style.background = "#28a745";
            inC = []; selP = null; updateUI(); cloudSave();
        }

        function apriModalTitolari() {
            const grid = document.getElementById('titolariGrid'); grid.innerHTML = "";
            convocati.forEach(p => {
                const b = document.createElement('button'); b.className = 'btn-sub'; b.innerText = p.n;
                b.onclick = () => { b.classList.toggle('active-in'); checkTit(); };
                grid.appendChild(b);
            });
            checkTit(); apriModal('modalTitolari');
        }

        function checkTit() {
            const count = document.querySelectorAll('#titolariGrid .active-in').length;
            const c = document.getElementById('confirmTitolari');
            c.disabled = count !== 5; c.innerText = `CONFERMA (${count}/5)`;
        }

        function confermaTitolari() {
            inC = Array.from(document.querySelectorAll('#titolariGrid .active-in')).map(b => b.innerText);
            chiudiModal('modalTitolari');
            document.getElementById('azioni').style.display = 'grid';
            document.getElementById('btnStato').innerText = "FINE Q" + nQ;
            document.getElementById('btnStato').style.background = "#dc3545";
            updateUI(); cloudSave();
        }

        function registraFalloFatto() { 
            if(!selP) return; 
            doFlash('red'); pF[selP]++;
            if(noiIsCasa) fH++; else fA++;
            salva("Fallo Fatto", selP, pF[selP]+"¬∞");
            updateUI(); if(pF[selP] >= 5) apriModalCambio(selP); cloudSave();
        }

        function apriModalCambio(autoOut=null) {
            const og = document.getElementById('outG'); og.innerHTML = "";
            const ig = document.getElementById('inG'); ig.innerHTML = "";
            document.getElementById('minutoCambio').value = "";
            convocati.forEach(p => {
                const b = document.createElement('button'); b.className = 'btn-sub'; b.innerText = p.n;
                if(inC.includes(p.n)) {
                    if(p.n == autoOut) b.classList.add('active-out');
                    b.onclick = () => { b.classList.toggle('active-out'); checkC(); };
                    og.appendChild(b);
                } else {
                    if(pF[p.n] >= 5) b.style.display = 'none';
                    b.onclick = () => { b.classList.toggle('active-in'); checkC(); };
                    ig.appendChild(b);
                }
            });
            checkC(); apriModal('modalCambio');
        }

        function checkC() {
            const outC = document.querySelectorAll('#outG .active-out').length;
            const inCCount = document.querySelectorAll('#inG .active-in').length;
            const t = document.getElementById('minutoCambio').value;
            let timeOk = (t.length === 3 && parseInt(t.substring(1)) <= 59);
            document.getElementById('confCambio').disabled = (outC !== inCCount || outC === 0 || !timeOk);
        }

        function eseguiCambio() {
            const t = document.getElementById('minutoCambio').value;
            const time = t[0] + ":" + t.substring(1);
            const o = Array.from(document.querySelectorAll('.active-out')).map(b=>b.innerText);
            const i = Array.from(document.querySelectorAll('.active-in')).map(b=>b.innerText);
            o.forEach(p => { inC = inC.filter(x => x != p); salva("Esce", p, time); });
            i.forEach(p => { inC.push(p); salva("Entra", p, time); });
            selP = null; chiudiModal('modalCambio'); updateUI(); cloudSave();
        }

        function addOppPoint(v) { 
            doFlash('red'); if(noiIsCasa) sA += v; else sH += v; 
            salva("Punti Avv", "Osp", "+"+v); updateUI(); cloudSave(); 
        }

        function registraFalloAvversario(num) {
            falliAvv[num]++;
            if(noiIsCasa) fA++; else fH++;
            salva("Fallo Avv", num, falliAvv[num]+"¬∞");
            chiudiModal('modalFalloAvversario');
            updateUI(); cloudSave();
        }

        // --- UTILS ---
        function updateUI() {
            document.getElementById('scoreHome').innerText = sH;
            document.getElementById('scoreAway').innerText = sA;
            document.getElementById('labelQuarto').innerText = nQ > 4 ? "OT" : "Q" + nQ;
            convocati.forEach(p => {
                const btn = document.getElementById('p'+p.n);
                if(btn) {
                    document.getElementById('pts'+p.n).innerText = pP[p.n];
                    document.getElementById('foul'+p.n).innerText = pF[p.n];
                    btn.className = "btn-giocatore " + (inC.includes(p.n) ? "in-campo " : "") + (selP == p.n ? "selected" : "");
                    if(pF[p.n] >= 5) btn.style.opacity = "0.4";
                }
            });
            renderDots('dotsHome', toH); renderDots('dotsAway', toA);
            
            // Popola griglie falli avversari
            const fGrid = document.getElementById('oppFoulGrid');
            const fNoiGrid = document.getElementById('oppFoulPerNoi');
            fGrid.innerHTML = ""; fNoiGrid.innerHTML = "";
            avversariNums.forEach(n => {
                const b = `<button class="btn-sub" onclick="registraFalloAvversario('${n}')">${n} (${falliAvv[n]})</button>`;
                fGrid.innerHTML += b;
                fNoiGrid.innerHTML += `<button class="btn-sub" onclick="registraFalloAvversario('${n}')">${n}</button>`;
            });
        }

        function renderDots(id, used) {
            const cont = document.getElementById(id); cont.innerHTML = "";
            let limit = (nQ <= 2) ? 2 : (nQ <= 4 ? 3 : 1);
            for(let i=0; i<limit; i++) cont.innerHTML += `<div class="dot ${i < used ? 'filled' : ''}"></div>`;
        }

        function segnaPunto(e){
            let r=document.getElementById('mappaCampo').getBoundingClientRect();
            lX=Math.round(e.clientX-r.left); lY=Math.round(e.clientY-r.top);
            let d=Math.sqrt(Math.pow(lX-155,2)+Math.pow(lY-30,2));
            currentVal=(d>130||(lY<30&&(lX<20||lX>290)))?3:2;
            document.getElementById('infoTiro').innerText = "Tiro da " + currentVal;
        }

        function regTiro(esito){
            if(!selP) return;
            if(esito==='SEGNATO'){ doFlash('green'); pP[selP]+=currentVal; if(noiIsCasa) sH+=currentVal; else sA+=currentVal; }
            salva("Tiro "+currentVal, selP, esito); chiudiModal('modalCampo'); updateUI(); cloudSave();
        }

        function cloudSave() { if(gameRef) gameRef.set({ nQ, sH, sA, fH, fA, toH, toA, inC, stats, pF, pP, falliAvv, noiIsCasa, oppName }); }
        function selezionaGiocatore(n) { if (inC.includes(n)) { selP = (selP === n) ? null : n; updateUI(); } }
        function logQuick(a, f) { if(selP) { doFlash(f); salva(a, selP, "-"); updateUI(); cloudSave(); } }
        function apriModal(id){ document.getElementById(id).style.display='flex'; }
        function chiudiModal(id){ document.getElementById(id).style.display='none'; }
        function salva(a,g,e){ stats.push({Q:nQ, G:g, Azione:a, Esito:e}); }
        function addTO(t) { if(t==='Home') toH++; else toA++; updateUI(); cloudSave(); }
        function concludiFalloSubito(lib){ chiudiModal('modalFalloSubito'); if(lib) apriModal('modalLibero'); }
    </script>
</body>
</html>
